'use strict';(function(){var c=jQuery,k=function(d){var e=d.element&&d.element.getNameAtt();return e?c(d.element.$).closest("form").find("input.cache").filter(function(){return c(this).attr("name")===e+"_cache"}):c()},g=function(d){try{return JSON.parse(d.val()||"{}")||{}}catch(e){return console&&console.log(e),{}}};CKEDITOR.plugins.add("xwiki-cache",{beforeInit:function(d){d._.xwikiCache=g(k(d));c(window).on("beforeunload",function(e){k(d).val(JSON.stringify(d._.xwikiCache))})}})})();(function(){var c=jQuery;CKEDITOR.plugins.add("xwiki-config",{});CKEDITOR.on("instanceCreated",function(k){k.editor.once("configLoaded",function(g){g=g.editor.config;g.sourceSyntax=g.sourceSyntax||(XWiki||{}).docsyntax;g.sourceDocument=g.sourceDocument||(XWiki||{}).currentDocument;var d="annotatedxhtml/1.0"!==g.htmlSyntax;if(g.sourceSyntax in g.allowedContentBySyntax){var e=c.extend(!0,{},g.allowedContentBySyntax[g.sourceSyntax]);!g.loadJavaScriptSkinExtensions&&"$1"in e&&"elements"in e.$1&&delete e.$1.elements.script;
var b=c.extend(!0,{},e);"$1"in b&&"elements"in b.$1&&delete b.$1.elements.figure;"$2"in b&&"elements"in b.$2&&delete b.$2.elements.figcaption;d||(e=b)}e&&!g.hasOwnProperty("allowedContent")&&(g.allowedContent=e);g=g["xwiki-image"]=g["xwiki-image"]||{};b&&!g.hasOwnProperty("captionAllowedContent")&&(g.captionAllowedContent=b)})})})();define("modalTranslationKeys",[],["ok","cancel","close"]);
define("modal",["jquery","l10n!modal","bootstrap"],function(c,k){var g=function(d){d=c.extend({title:"",content:"",acceptLabel:k.get("ok"),dismissLabel:k.get("cancel")},d);var e=c('<div class="modal" tabindex="-1" role="dialog" data-backdrop="static"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title"></h4></div><div class="modal-body"></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" disabled="disabled">OK</button></div></div></div></div>').addClass(d["class"]).appendTo(document.body);e.find(".close").attr({title:k.get("close"),
"aria-label":k.get("close")});e.find(".modal-title").text(d.title);e.find(".modal-body").html("").append(d.content);e.find(".modal-footer .btn-primary").text(d.acceptLabel);e.find('.modal-footer .btn[data-dismiss="modal"]').text(d.dismissLabel);return e};c.fn.loadRequiredSkinExtensions=function(d){return this.each(function(){var e=c(this.ownerDocument||this.document||this).find("head"),b,f=function(){return e.find("link, script").map(function(){return c(this).attr("href")||c(this).attr("src")}).get()};
c("<div></div>").html(d).find("link, script").filter(function(){b||=f();var n=c(this).attr("href")||c(this).attr("src");return 0>b.indexOf(n)}).appendTo(e)})};return{createModal:g,createModalStep:function(d){var e;return function(b){e||(e=g(d),d&&"function"===typeof d.onLoad&&d.onLoad.call(e),e.on("hidden.bs.modal",function(n){n=e.data("deferred");var h=e.data("output");"undefined"===typeof h?n.reject():n.resolve(h)}));var f=c.Deferred();e.is(":hidden")?e.data({deferred:f,input:b}).removeData("output").modal():
f.reject();return f.promise()}}}});(function(){CKEDITOR.plugins.add("xwiki-dialog",{});CKEDITOR.plugins.xwikiDialog={getUIElementPath:function(c,k){for(var g=0;g<k.length;g++){var d=k[g];if(d.id===c)return[{element:d,position:g}];var e=d.children||d.elements;if(e&&(e=this.getUIElementPath(c,e)))return e.push({element:d,position:g}),e}return null},replaceWith:function(c,k,g){(c=this.getUIElementPath(k,c.contents))&&1<c.length&&(k=c[1].element,(k.children||k.elements).splice(c[0].position,1,g))}}})();(function(){CKEDITOR.config["xwiki-filter"]=CKEDITOR.config["xwiki-filter"]||{__namespace:!0};CKEDITOR.plugins.add("xwiki-filter",{init:function(c){var k={elements:{div:function(f){if("wikimodel-emptyline"===f.attributes["class"])return f.name="p",delete f.attributes["class"],f}}},g={elements:{p:function(f){var n=f.getIndex();if(n=0<n&&n<f.parent.children.length-1)a:{n=f.children;for(var h=0;h<n.length;h++){var a=n[h];if(a.type===CKEDITOR.NODE_ELEMENT&&("br"!==a.name||h!==n.length-1)||a.type===CKEDITOR.NODE_TEXT&&
""!==CKEDITOR.tools.htmlDecode(a.value).trim()){n=!1;break a}}n=!0}if(n)return f.name="div",f.attributes["class"]="wikimodel-emptyline",f},div:function(f){if("wikimodel-emptyline"===f.attributes["class"])for(;0<f.children.length;)f.children[0].remove()}}},d={elements:{html:function(f){if(!c.config.fullData){var n=f.getFirst("body");f.children=n?[n]:[]}},body:function(f){c.config.fullData||(f.attributes={})},script:function(f){if(!c.config.fullData)return!1}}},e={comment:function(f){if("{cke_protected}%3Cscript%20"===
f.substr(0,27)&&(f=CKEDITOR.htmlParser.fragment.fromHtml("<script "+decodeURIComponent(f.substr(27))).children[0])&&"script"===f.name&&("true"===f.attributes["data-wysiwyg"]||"string"===typeof f.attributes.src&&0<f.attributes.src.indexOf("wysiwyg=true")))return f}},b=c.dataProcessor&&c.dataProcessor.dataFilter;b&&(b.addRules(k,{priority:5}),c.config.loadJavaScriptSkinExtensions&&b.addRules(e,{priority:5}));if(k=c.dataProcessor&&c.dataProcessor.htmlFilter)k.addRules(g,{priority:14,applyToAll:!0}),
k.addRules(d,{priority:5,applyToAll:!0});c.filter.addTransformations([[{element:"font",left:function(f){return f.attributes.color||f.attributes.face},right:function(f){f.styles=f.styles||{};f.attributes.color&&(f.styles.color=f.attributes.color,delete f.attributes.color);f.attributes.face&&(f.styles["font-family"]=f.attributes.face,delete f.attributes.face);delete f.attributes.size;f.name="span";return f}}]]);this.maybeFixNonBreakingSpaceOnDelete(c)},nbspTimeout:null,maybeFixNonBreakingSpaceOnDelete:function(c){var k=
this;c.on("key",function(g){if(8===g.data.keyCode||46===g.data.keyCode)clearTimeout(k.nbspTimeout),k.nbspTimeout=setTimeout(k.maybeFixNonBreakingSpaceAfterDelete.bind(k,c),0)})},maybeFixNonBreakingSpaceAfterDelete:function(c){if((c=c.getSelection())&&c.isCollapsed()){var k=c.getRanges()[0],g=this.maybeFixNonBreakingSpaceAt(k.startContainer,k.startOffset);g&&(k.setEnd(g.node,g.offset),k.collapse(),c.selectRanges([k]))}},maybeFixNonBreakingSpaceAt:function(c,k){if(c.type===CKEDITOR.NODE_ELEMENT){var g=
function(e,b){for(var f=[];e&&e.type===CKEDITOR.NODE_TEXT;)f.push(e),e=e[b]();return f},d=g(c.getChild(k-1),"getPrevious");c=g(c.getChild(k),"getNext");return this.maybeFixNonBreakingSpace(d,c)}if(c.type===CKEDITOR.NODE_TEXT){if(0===k)return this.maybeFixNonBreakingSpaceAt(c.getParent(),c.getIndex());if(k===c.getLength())return this.maybeFixNonBreakingSpaceAt(c.getParent(),c.getIndex()+1)}},maybeFixNonBreakingSpace:function(c,k){var g=c.map(function(e){return e.getText()}).join("");k=k.map(function(e){return e.getText()}).join("");
var d=!1;/\S$/.test(g)&&/^\u00a0\S/.test(k)?(k=" "+k.substring(1),d=!0):/\S\u00a0$/.test(g)&&/^\S/.test(k)&&(g=g.substring(0,g.length-1)+" ",d=!0);if(d){for(c=c[0];c.hasNext()&&c.getNext().type===CKEDITOR.NODE_TEXT;)c.getNext().remove();c.setText(g+k);return{node:c,offset:g.length}}}})})();(function(){CKEDITOR.config["xwiki-focusedplaceholder"]=CKEDITOR.config["xwiki-focusedplaceholder"]||{__namespace:!0,placeholder:{__namespace:!0}};CKEDITOR.plugins.add("xwiki-focusedplaceholder",{init:function(c){function k(g){if(g.type===CKEDITOR.NODE_TEXT)return g.isEmpty();for(g=g.getFirst();g;g=g.getNext())if(!c.config["xwiki-focusedplaceholder"].ignoreIfEmpty.includes(g.getName?.())||!k(g))return!1;return!0}c.config["xwiki-focusedplaceholder"].ignoreIfEmpty||(c.config["xwiki-focusedplaceholder"].ignoreIfEmpty=
"#text a abbr b bdi bdo br cite data dfn em i mark s small span strong time u var wbr del ins".split(" "));"body address aside footer header h1 h2 h3 h4 h5 h6 main nav section blockquote dl dt dd figcaption figure ol ul menu li p pre caption th td".split(" ").forEach(function(g){c.config["xwiki-focusedplaceholder"].placeholder[g]||(c.config["xwiki-focusedplaceholder"].placeholder[g]=`xwiki-focusedplaceholder.placeholder.${g}`)});(c.dataProcessor&&c.dataProcessor.htmlFilter).addRules({attributes:{["data-xwiki-focusedplaceholder"]:function(){return!1}}},
{applyToAll:!0});["change","selectionChange","blur"].forEach(g=>{c.on(g,d=>{d=d.editor;var e=d.editable()?.findOne("[data-xwiki-focusedplaceholder]");a:{var b=d.getSelection();if(b?.isCollapsed()&&d.focusManager.hasFocus&&(b=b.getRanges()[0].startContainer,k(b))){for(;b&&(b.type!==CKEDITOR.NODE_ELEMENT||!c.config["xwiki-focusedplaceholder"].placeholder[b.getName()]);)b=b.getParent();if(b&&k(b))break a}b=void 0}if(b!==e){d.fire("lockSnapshot");e?.removeAttribute("data-xwiki-focusedplaceholder");if(null!=
b){e=b.setAttribute;var f=b?.getName();f=c.config["xwiki-focusedplaceholder"].placeholder[f];f=void 0===f?"":c.localization.get(f);e.call(b,"data-xwiki-focusedplaceholder",f)}d.fire("unlockSnapshot")}})})}})})();define("xwiki-iconService",["jquery"],function(c){const k=function(e,b){e=Object.assign({outputSyntax:"plain",action:e},b);return(new XWiki.Document("IconPicker","IconThemesCode")).getURL("get",c.param(e),!0)};let g=!1;const d={};return{getIconThemes:function(){return new Promise(function(e,b){g?e(g):c.getJSON(k("data_iconthemes"),function(f){g=f;e(f)}).fail(b)})},getIcons:function(e){return new Promise(function(b,f){d[e]?b(d[e]):c.getJSON(k("data_icons",{iconTheme:e}),function(n){d[e]=n;b(n)}).fail(f)})}}});(function(){CKEDITOR.plugins.add("xwiki-icon",{init:function(c){c.config.mentions=c.config.mentions||[];c.config.mentions.push({marker:"icon::",pattern:RegExp("icon::\\S{0,30}$"),minChars:0,itemsLimit:0,itemTemplate:'<li data-id="{id}">\n            <div class="ckeditor-autocomplete-item-head">\n              <span class="ckeditor-autocomplete-item-icon-wrapper"><span class="{iconClass}" aria-hidden="true"></span>\n                <img src="{imgSrc}" role="presentation"></img>\n              </span>\n              <span class="ckeditor-autocomplete-item-label">{label}</span>\n            </div>\n          </li>',
feed:function(k,g){require(["xwiki-iconService"],function(d){d.getIconThemes().then(function(e){d.getIcons(e.currentIconTheme).then(function(b){g(b.filter(f=>f.name.toLowerCase().startsWith(k.query.toLowerCase())).map(f=>({id:f.name,label:f.name,imgSrc:f.metadata.url,iconClass:f.metadata.cssClass})))}).catch(function(){c.showNotification(c.localization.get("xwiki-icon.iconsFetchFailed"),"warning",5E3)})}).catch(function(){c.showNotification(c.localization.get("xwiki-icon.iconThemesFetchFailed"),"warning",
5E3)})})},outputTemplate:function(k){c.execCommand("xwiki-macro-insert",{name:"displayIcon",parameters:{name:k.id},inline:"enforce"});return""}})}})})();(function(){CKEDITOR.config["xwiki-image"]=CKEDITOR.config["xwiki-image"]||{__namespace:!0};CKEDITOR.plugins.add("xwiki-image-old",{requires:"xwiki-marker,xwiki-resource,balloontoolbar",beforeInit:function(e){e.on("widgetDefinition",function(b){b=b.data;"image"===b.name&&"image2"===b.dialog&&this.overrideImageWidget(e,b)},this)},init:function(e){e.plugins["xwiki-marker"].addMarkerHandler(e,"image",{toHtml:function(b,f){if(1===f.length&&"img"===f[0].name)f=f[0],b=b.value.substring(11),f.attributes["data-reference"]=
CKEDITOR.tools.unescapeComment(b),f.hasClass("wikimodel-freestanding")&&(f.attributes["data-freestanding"]=!0,f.removeClass("wikimodel-freestanding"),delete f.attributes.alt),f.hasClass("wikigeneratedid")&&(f.attributes["data-wikigeneratedid"]="true",f.removeClass("wikigeneratedid"));else return!1},isMarked:function(b){return"img"===b.name&&b.attributes["data-reference"]},toDataFormat:function(b){var f=CKEDITOR.tools.escapeComment(b.attributes["data-reference"]),n=new CKEDITOR.htmlParser.comment("startimage:"+
f),h=new CKEDITOR.htmlParser.comment("stopimage");n.insertBefore(b);h.insertAfter(b);delete b.attributes["data-reference"];n="true"===b.attributes["data-freestanding"];delete b.attributes["data-freestanding"];if(f=n&&!/\s+/.test(f))a:{for(var a in b.attributes)if(b.attributes.hasOwnProperty(a)&&"src"!==a&&""!==b.attributes[a]){f=!1;break a}f=!0}f&&b.addClass("wikimodel-freestanding");a="true"===b.attributes["data-wikigeneratedid"];delete b.attributes["data-wikigeneratedid"];a&&b.addClass("wikigeneratedid")}});
e.balloonToolbars.create({buttons:"Link,Unlink,Image",widgets:"image"})},overrideImageWidget:function(e,b){var f=b.init;b.init=function(){f.call(this);var l=this.parts.image.getAttribute("data-reference");l&&this.setData("resourceReference",CKEDITOR.plugins.xwikiResource.parseResourceReference(l))};var n=b.data;b.data=function(){var l=this.data.resourceReference;l&&this.parts.image.setAttribute("data-reference",CKEDITOR.plugins.xwikiResource.serializeResourceReference(l));n.call(this)};if(e=(e.config["xwiki-image"]||
{}).captionAllowedContent)b.editables.caption.allowedContent=e;var h=function(l,m){var r="string"===typeof l.attributes[m]&&l.attributes[m].trim();if(r.length&&"%"===r.charAt(r.length-1))return l[m+"%"]=l.attributes[m],delete l.attributes[m],!0},a=function(l,m){l[m+"%"]&&(l.attributes[m]=l[m+"%"],delete l[m+"%"])},t=b.upcast;b.upcast=function(l,m){var r=[];l.forEach(function(q){"img"===l.name&&h(l,"width")|h(l,"height")&&r.push(l)},CKEDITOR.NODE_ELEMENT);try{return t.apply(this,arguments)}finally{r.forEach(function(q){a(q,
"width");a(q,"height")})}}}});CKEDITOR.on("dialogDefinition",function(e){if(e.editor.plugins["xwiki-image-old"]){var b=e.data.definition;"image2"===e.data.name&&(c(b,"src",{resourceTypes:(e.editor.config["xwiki-image"]||{}).resourceTypes||["attach","icon","url"],setup:function(f){this.setValue(f.data.resourceReference)},commit:function(f){var n=f.data.resourceReference||{},h=this.getValue();if(n.type!==h.type||n.reference!==h.reference)h.typed="attach"!==h.type&&("url"!==h.type||0>h.reference.indexOf("://")),
f.setData("resourceReference",CKEDITOR.tools.extend(h,n))}}),CKEDITOR.plugins.xwikiResource.updateResourcePickerOnFileBrowserSelect(b,["info","resourceReference"],["Upload","uploadButton"]),k(b))}});var c=function(e,b,f){(e=CKEDITOR.plugins.xwikiDialog.getUIElementPath(b,e.contents))&&2<e.length&&(f=CKEDITOR.plugins.xwikiResource.createResourcePicker(f),CKEDITOR.plugins.xwikiResource.bindResourcePicker(e[0].element,[e[e.length-1].element.id,f.id],void 0,function(n,h,a,t){var l=a.getValueOf(t[0],"width");
a=a.getValueOf(t[0],"height");return h&&(l||a)?(h={},l&&(h.width=l),a&&(h.height=a),n+"&"+$.param({"parameters[queryString]":$.param(h)})):n}),e[1].element.hidden=!0,e[2].element.children.splice(e[1].position,0,f))},k=function(e){e=e.getContents("info");d(e,"width");d(e,"height")},g=/^\s*(\d+%)\s*$/i,d=function(e,b){var f=e.get(b).validate;e.get(b).validate=function(){return this.getValue().match(g)||f.apply(this,arguments)}}})();define("attachmentService",["jquery","xwiki-attachment-picker-solr-search"],function(c,k){var g={};c=function(){g={global:{},local:{}}};c();return{getAttachments:function(d,e,b,f,n){return new Promise(function(h){var a=g[e?"global":"local"][d];if(a&&!b)return h(a);(new k({limit:40,target:XWiki.Model.serialize(f.config.sourceDocument.documentReference),solrOptions:{sort:"attdate_sort "+n}})).search(d,e).then(function(t){g[e?"global":"local"][d]=t;h(t)})})},clearCache:c}});define("imageEditorTranslationKeys",[],"modal.changeImage.button modal.loadFail.message modal.title modal.insertButton modal.updateButton modal.initialization.fail modal.outscaleWarning".split(" "));
define("imageStyleClient",["jquery"],function(c){function k(){return void 0===d?Promise.resolve(c.getJSON(XWiki.contextPath+c("#imageStylesRestURL").val(),c.param({documentReference:XWiki.Model.serialize(XWiki.currentDocument.documentReference)})).then(function(e){return d=e})):Promise.resolve(d)}var g,d;return{loadImageStyles:k,loadImageStylesDefault:function(){return void 0===g?Promise.resolve(c.getJSON(XWiki.contextPath+c("#defaultImageStylesRestURL").val(),c.param({documentReference:XWiki.Model.serialize(XWiki.currentDocument.documentReference)}))).then(function(e){return g=
e}):Promise.resolve(g)},getImageStyle:function(e){return k().then(function(b){b=b.imageStyles.filter(function(f){return f.type===e});return 0===b.length?Promise.reject("Unable to find an image style with id ["+e+"]"):Promise.resolve(b[0])})}}});
define("imageEditor",["jquery","modal","imageStyleClient","l10n!imageEditor","xwiki-selectize"],function(c,k,g,d){function e(w){return new Promise(function(y,z){var A=c("#imageStyles");0<A.length?g.loadImageStylesDefault().then(function(E){x=E;A.xwikiSelectize({preload:!0,persist:!0,onChange:function(G){q(G,w)},load:function(G,B){g.loadImageStyles().then(function(C){var F=C.imageStyles.map(function(D){let H=D.type;"true"===E.forceDefaultStyle&&D.identifier===E.defaultStyle&&(H="");return{label:D.prettyName,
value:H}});"true"!==E.forceDefaultStyle&&F.unshift({label:"---",value:""});v=F;B(F);C=C.imageStyles.filter(D=>D.identifier===E.defaultStyle);F="";"true"!==E.forceDefaultStyle&&0<C.length&&(F=C[0].type);A.data("selectize").addItem(F||"")},function(C){z(C)})},onLoad:function(){y()}})},function(E){z(E)}):y()})}function b(w,y){c('<button type="button" class="btn btn-default pull-left"></button>').text(d.get("modal.changeImage.button")).prependTo(w.parent()).on("click",function(){var z=m(y),A=y.data("input");
y.data("output",{action:"selectImage",editor:A.editor,imageData:z,newImage:!0===A.newImage}).modal("hide")})}function f(w){var y=new Image,z=c.Deferred();y.onload=function(){z.resolve(this)};y.onerror=function(){z.reject(this)};w=w.data("input");y.src=r(w.imageData.resourceReference,w.editor);return z}function n(w){f(w).then(function(y){var z=w.find('[name="imageWidth"]'),A=w.find('[name="imageHeight"]'),E=w.find(".outscaleWarning"),G=y.width;y=y.height;var B=z.val(),C=A.val();B=B>G;C=C>y;B?z.parent("label").addClass("has-warning"):
z.parent("label").removeClass("has-warning");C?A.parent("label").addClass("has-warning"):A.parent("label").removeClass("has-warning");B||C?(E.parent(".has-warning").removeClass("hidden"),E.text(d.get("modal.outscaleWarning",G+"x"+y+"px"))):E.parent(".has-warning").addClass("hidden")})}function h(w){var y=w.find(".image-size-locked"),z=w.find(".image-size-unlocked");(w=w.data("input").imageData.isLocked)?(y.removeClass("hidden"),z.addClass("hidden")):(y.addClass("hidden"),z.removeClass("hidden"));
return w}function a(w){function y(G,B){return f(w).then(function(C){var F=C.width;C=C.height;var D=/^(\d+)(.*)/.exec(B);if(null===D)D=F="";else{var H=parseInt(D[1],10);D=D[2];F="width"===G?Math.round(H/F*C):Math.round(H/C*F)}return 0===F?"":F+D},function(){})}function z(G,B,C){var F=B.val();return w.data("input").imageData.isLocked?(A.prop("disabled",!0),E.prop("disabled",!0),c.when(y(G,F)).then(function(D){void 0!==D&&C.val(D);A.prop("disabled",!1);E.prop("disabled",!1);B.focus()})):c.Deferred().resolve()}
var A=w.find('[name="imageWidth"]'),E=w.find('[name="imageHeight"]');w.find(".image-size-lock").on("click",function(){w.data("input").imageData.isLocked=!w.data("input").imageData.isLocked;h(w)});A.on("input",function(){z("width",c(this),E).then(function(){n(w)})});E.on("input",function(){z("height",c(this),A).then(function(){n(w)})})}function t(w){var y=w.find('[name="alignment"]'),z=w.find('[name="textWrap"]'),A=w.find('[name="alignment"][value="none"]');y.change(function(){"none"!==this.value&&
z.prop("checked",!1)});z.change(function(){this.checked&&A.prop("checked",!0)})}function l(w){var y=w.data("input");y.newImage?w.find(".modal-footer .btn-primary").text(d.get("modal.insertButton")):w.find(".modal-footer .btn-primary").text(d.get("modal.updateButton"));if(w.data("initialized"))u(w);else{var z=(new XWiki.Document(XWiki.Model.resolve("CKEditor.ImageEditorService",XWiki.EntityType.DOCUMENT))).getURL("get");c.get(z,c.param({language:c("html").attr("lang"),isHTML5:"annotatedhtml/5.0"===
y.editor.config.htmlSyntax})).done(function(A,E,G){var B=c(".image-editor");E=G.getResponseHeader("X-XWIKI-HTML-HEAD");c(document).loadRequiredSkinExtensions(E);B.html(A);e(w).then(function(){B.removeClass("loading");c(".image-editor-modal button.btn-primary").prop("disabled",!1);u(w);w.data("initialized",!0)});a(w);t(w)}).fail(function(A){new XWiki.widgets.Notification(d.get("modal.initialization.fail"),"error");console.log("Failed to retrieve the image edition form.",A)})}}function m(w){var y=w.data("input").imageData.resourceReference,
z=c("#imageWidth").val(),A=c("#imageHeight").val();return{resourceReference:y,imageStyle:c("#imageStyles").val(),alignment:c('#advanced [name="alignment"]:checked').val(),border:c('#advanced [name="imageBorder"]').prop("checked"),textWrap:c('#advanced [name="textWrap"]').prop("checked"),alt:c("#altText").val(),hasCaption:!!c("#imageCaptionActivation").prop("checked"),width:z,height:A,src:r(y,w.data("input").editor,{"parameters[queryString]":c.param({width:z,height:A})}),isLocked:w.data("input").imageData.isLocked}}
function r(w,y,z){y=CKEDITOR.plugins.xwikiResource.getResourceURL(w,y);"url"!==w.type&&(y=y+"&"+c.param(z||{}));return y}function q(w,y){function z(B,C,F){var D=!1!==B.adjustableSize,H=c("#imageWidth"),I=c("#imageHeight");H.prop("disabled",!D&&!C);I.prop("disabled",!D&&!C);F&&(H.val(B.defaultWidth),I.val(B.defaultHeight))}function A(B,C,F){var D=c("#imageBorder");D.prop("disabled",!B.adjustableBorder&&!C);F&&D.prop("checked",B.defaultBorder)}function E(B,C,F){var D=c('#advanced [name="alignment"]');
D.prop("disabled",!B.adjustableAlignment&&!C);F&&D.val([B.defaultAlignment||"none"])}function G(B,C,F){var D=c('#advanced [name="textWrap"]');D.prop("disabled",!B.adjustableTextWrap&&!C);F&&D.prop("checked",B.defaultTextWrap)}g.loadImageStyles().then(function(B){var C=void 0===y.data("input").imageData||y.data("input").imageData.imageStyle!==w;y.data("input").imageData=y.data("input").imageData||{};var F=y.data("input").imageData.imageStyle=w;"true"===x.forceDefaultStyle&&""===w&&(F=x.defaultStyle);
B=(B.imageStyles||[]).find(function(H){return""!==H.type&&H.identifier===F});var D=!1;void 0===B&&(B={},D=!0,C=!1);z(B,D,C);A(B,D,C);E(B,D,C);G(B,D,C)})}function p(w){if(w.imageStyle||""===w.imageStyle){var y=w.imageStyle;void 0!==v&&(v.some(z=>z.value===w.imageStyle)||(y=""));c("#imageStyles")[0].selectize.setValue(y)}}function u(w){var y=w.data("input").imageData||{},z=w.data("input").editor;z=z.filter.checkFeature(z.widgets.registered.image.features.caption);const A=c("#imageCaptionActivation").parents("dd"),
E=A.prev();z?(A.removeClass("hidden"),E.removeClass("hidden")):(A.addClass("hidden"),E.addClass("hidden"),w.data("input").imageData.hasCaption=!1);c('.image-editor a[href="#standard"]').tab("show");p(y);c("#altText").val(y.alt);c("#imageCaptionActivation").prop("checked",y.hasCaption);c("#imageWidth").val(y.width);c("#imageHeight").val(y.height);c("#imageBorder").prop("checked",y.border);c('#advanced [name="alignment"]').val([y.alignment||"none"]);y.alignment&&"none"!==y.alignment&&(y.textWrap=!1);
c('#advanced [name="textWrap"]').prop("checked",y.textWrap);q(c("#imageStyles")[0].selectize.getValue(),w);n(w);if(void 0===w.data("input").imageData.isLocked||w.data("input").newImage)w.data("input").imageData.isLocked=!0;h(w)}var v,x;return k.createModalStep({"class":"image-editor-modal",title:d.get("modal.title"),acceptLabel:d.get("modal.insertButton"),content:'<div class="image-editor loading"></div>',onLoad:function(){var w=this,y=w.find(".modal-footer .btn-primary");w.find(".modal-dialog").addClass("modal-lg");
w.on("shown.bs.modal",function(){l(w)});y.on("click",function(){var z=m(w);w.data("output",z).modal("hide")});b(y,w)}})});define("imageSelectorTranslationKeys",[],"modal.title modal.loadFail.message modal.selectButton modal.fileUpload.success modal.fileUpload.fail modal.fileUpload.abort modal.initialization.fail".split(" "));
define("imageSelector",["jquery","modal","resource","l10n!imageSelector"],function(c,k,g,d){function e(h){function a(q){q?(r.data("imageReference",{value:q}),c(".image-selector-modal button.btn-primary").prop("disabled",!1)):(r.data("imageReference",{}),c(".image-selector-modal button.btn-primary").prop("disabled",!0))}function t(q){if(!q.data("initialized")){var p=(new XWiki.Document(XWiki.Model.resolve("CKEditor.ImageSelectorService",XWiki.EntityType.DOCUMENT))).getURL("get");c.get(p,c.param({language:c("html").attr("lang"),
index:l,documentReference:h})).done(function(u,v,x){v=q.find(".image-selector");x=x.getResponseHeader("X-XWIKI-HTML-HEAD");v.html(u);c(document).loadRequiredSkinExtensions(x);c(document).trigger("xwiki:dom:updated",{elements:v.toArray()});v.removeClass("loading");v.on("show.bs.tab",function(w){w=c(w.target).attr("aria-controls");a(m[w])});q.data("initialized",!0)}).fail(function(u){console.log("Failed to retrieve the image selection form.",u);new XWiki.widgets.Notification(d.get("modal.initialization.fail"),
"error");q.data("initialized",!0)})}}var l=f;f+=1;var m={},r;return{open:k.createModalStep({"class":"image-selector-modal",title:d.get("modal.title"),acceptLabel:d.get("modal.selectButton"),content:'<div class="image-selector loading"></div>',onLoad:function(){r=this;var q=r.find(".modal-footer .btn-primary");r.find(".modal-dialog").addClass("modal-lg");r.on("shown.bs.modal",function(){t(r)});q.on("click",function(){var p=r.data("input").imageData||{};p.resourceReference=r.data("imageReference").value;
p={imageData:p,editor:r.data("input").editor,newImage:r.data("input").newImage};r.data("output",p).modal("hide")})}}),updateSelectedImageReferences:function(q){q=q||[];if(0<q.length){q=q[0];if("string"===typeof q){var p=g.convertEntityReferenceToResourceReference;if(q.startsWith("attachment:")){var u=q.indexOf(":");u=q.substr(u+1)}else u=q;u=XWiki.Model.resolve(u,XWiki.EntityType.ATTACHMENT);p=p.call(g,u)}else p=q;p.typed="icon"===q.type}m[r.find(".image-selector .tab-pane.active").attr("id")]=p;
a(p)},createLoader:function(q,p){p=p||{};var u=r.data("input").editor;q=u.uploadRepository.create(q);q.on("uploaded",function(v){v=g.convertResourceReferenceToEntityReference(v.sender.responseData.message.resourceReference);if(p.onSuccess)p.onSuccess(v)});q.on("error",function(v){console.log("Failed to upload a file",v);if(p.onError)p.onError()});q.on("abort",function(v){console.log("Failed to upload a file",v);if(p.onAbort)p.onAbort()});q.loadAndUpload(u.config.filebrowserUploadUrl)}}}function b(h){return XWiki.Model.serialize(h.editor.config.sourceDocument.documentReference)}
var f=0,n={};return{open:function(h){var a=b(h);n[a]||(n[a]=e(a));return n[a].open(h)},updateSelectedImageReferences:function(h,a){a=b(a.parents(".image-selector-modal").data("input"));n[a].updateSelectedImageReferences(h)},createLoader:function(h,a,t){t=b(t.parents(".image-selector-modal").data("input"));n[t].createLoader(h,a)},getDocumentReference:function(h){return b(h.parents(".image-selector-modal").data("input"))}}});define("imageWizard",["jquery","imageSelector","imageEditor"],function(c,k,g){function d(b){return"selectImage"===b.action?e(b):b}function e(b){b=b||{};void 0===b.newImage&&(b.newImage=!0);return k.open(b).then(g).then(d)}return function(b){CKEDITOR.currentInstance&&(b.currentDocument=CKEDITOR.currentInstance.config.sourceDocument.documentReference);return b.setImageData?c.Deferred().resolve(b.setImageData):!1===b.isInsert?g(b).then(d):e(b)}});(function(){function c(g){require(["imageStyleClient"],function(d){g.resizer.removeClass("hidden");var e=g.data.imageStyle;e&&d.getImageStyle(e).then(function(b){!1===b.adjustableSize&&g.resizer.addClass("hidden")},function(){console.debug("Failed to resolve image style ["+e+"]")})})}function k(g,d,e,b){require(["imageWizard"],function(f){f({editor:g,imageData:Object.assign({},d.data),isInsert:e,setImageData:b}).done(function(n){if(d&&d.element){if(d.setData(n),c(d),"p"===d.element.getName()){n=d.element;
var h=n.findOne("a,img");h.replace(n);d.element=h;d.element.setAttribute("data-widget",d.name)}}else{h=CKEDITOR.dom.element.createFromHtml("<span>"+d.template.output()+"</span>",g.document);var a=g.widgets.wrapElement(h,d.name),t=new CKEDITOR.dom.documentFragment(a.getDocument());t.append(a);g.widgets.initOn(h,d,{}).setData(n);g.widgets.finalizeCreation(t)}})})}CKEDITOR.plugins.add("xwiki-image",{requires:"xwiki-image-old,xwiki-dialog",beforeInit:function(g){g.on("widgetDefinition",function(d){d=
d.data;"image"===d.name&&"image2"===d.dialog&&this.overrideImageWidget(g,d)},this)},init:function(g){g.config.mentions=g.config.mentions||[];g.config.mentions.push({marker:"img::",pattern:/img::\S{0,30}$/,minChars:0,itemsLimit:5,itemTemplate:'<li data-id="{id}"><div class="ckeditor-autocomplete-item-head {extraClass}"><span class="ckeditor-autocomplete-item-{type}-wrapper"><span class="{iconClass}" aria-hidden="true"></span><img src="{imgSrc}" aria-hidden="true"/></span><div class="ckeditor-autocomplete-item"><span class="ckeditor-autocomplete-item-label">{label}</span><div class="ckeditor-autocomplete-item-badges"><span class="badge ckeditor-autocomplete-item-badge">{badge}</span></div><div class="ckeditor-autocomplete-item-hint">{space}</div></div></div></li>',
feed:function(d,e){require(["attachmentService"],function(b){const f=function(r){var q="";r.isLocal&&(q=g.localization.get("xwiki-image.slash.currentPageBadge"));XWiki.currentWiki!==r.wiki&&(q=g.localization.get("xwiki-image.slash.externalBadge"));return{id:r.id,label:r.filename[0],iconClass:"",badge:q,space:(XWiki.currentWiki===r.wiki?"":r.wiki+" : ")+r.location,type:"preview",imgSrc:CKEDITOR.plugins.xwikiResource.getResourceURL({type:"attach",typed:!1,reference:r.id},g),reference:r.id,extraClass:""}},
n={id:"_loading",extraClass:"ckeditor-autocomplete-centered",label:g.localization.get("xwiki-image.slash.loading"),iconClass:"fa fa-spinner fa-pulse fa-fw",type:"icon",space:"",badge:"",imgSrc:"",query:d.query};var h={id:"_uploadImage",label:g.localization.get("xwiki-image.slash.upload"),iconClass:"fa fa-upload",extraClass:"ckeditor-autocomplete-centered",space:"",badge:"",imgSrc:"",type:"icon"};const a=[];h.label.toLowerCase().startsWith(d.query.toLowerCase())&&a.push(h);const t=function(r){return r.mimetype.some(function(q){return q.startsWith("image/")})};
e(a.concat([n]));h=b.getAttachments(`*${d.query}*`,!1,!1,g,"desc");const l=b.getAttachments(`*${d.query}*`,!0,!1,g,"desc"),m=b.getAttachments("*",!0,!1,g,"desc");b=b.getAttachments("*",!0,!1,g,"desc");b=Promise.all([m,b]).then(function(r){const q=[...a,n],p=[],u={};r.flat().forEach(function(v){t(v)&&!u[v.id]&&v.filename[0].toLowerCase().includes(d.query.toLowerCase())&&(u[v.id]=!0,p.push(v),q.push(f(v)))});e(q);return p});Promise.all([h,l,b]).then(function(r){const q={};r.flat().forEach(function(p){t(p)&&
!q[p.id]&&(q[p.id]=!0,a.push(f(p)))});e(a)})})},outputTemplate:function(d){const e=g.widgets.registered.image;if("_loading"===d.id)return"img::"+d.query;require(["jquery","resource"],function(b,f){if("_uploadImage"===d.id){const n="<script src="+`'${XWiki.contextPath}/${XWiki.servletpath}`+"skin/resources/uicomponents/suggest/suggestAttachments.js'defer='defer'>\x3c/script>";b(CKEDITOR.document.$).loadRequiredSkinExtensions(n);require(["attachmentService","xwiki-attachments-store","xwiki-file-picker"],
function(h,a,t){const l=function(m,r){const q=[];for(var p=0;p<m.length;p++){const u=m.item(p),v=new XWiki.EntityReference(u.name,XWiki.EntityType.ATTACHMENT,r);q.push(a.create(v,u))}return q};t.pickLocalFiles({accept:"image/*",multiple:!1}).then(function(m){m=l(m,g.config.sourceDocument.documentReference);if(0!==m.length){var r=m[0],q=new XWiki.widgets.Notification(g.localization.get("xwiki-image.slash.uploadProgress",r.name),"inprogress");m=XWiki.Model.resolve(r.id,XWiki.EntityType.ATTACHMENT);
a.upload(m,r.file).then(()=>{q.replace(new XWiki.widgets.Notification(g.localization.get("xwiki-image.slash.uploadSuccess",r.name),"done"));h.clearCache();const p={...f.convertEntityReferenceToResourceReference(XWiki.Model.resolve(r.id,XWiki.EntityType.ATTACHMENT),g.config.sourceDocument.documentReference),typed:!1};e.insert({setImageData:{resourceReference:p,src:CKEDITOR.plugins.xwikiResource.getResourceURL(p,g)}})}).catch(()=>{q.replace(new XWiki.widgets.Notification(g.localization.get("xwiki-image.slash.uploadError",
r.name),"error"));return Promise.reject()})}})})}else b={...f.convertEntityReferenceToResourceReference(XWiki.Model.resolve(d.reference,XWiki.EntityType.ATTACHMENT),g.config.sourceDocument.documentReference),typed:!1},e.insert({setImageData:{resourceReference:b,src:CKEDITOR.plugins.xwikiResource.getResourceURL(b,g)}})});return""}});this.initImageDialogWidget(g)},initImageDialogWidget:function(g){var d=g.widgets.registered.image;d.insert=function(e){k(g,this,!0,e&&e.setImageData)};d.edit=function(e){e.cancel();
k(g,this,!1)}},overrideImageWidget:function(g,d){function e(l){if(0===l.element.find(".cke_image_resizer_wrapper",!0).count()){var m=g.document.createElement("span");m.addClass("cke_image_resizer_wrapper");m.append(l.parts.image);m.append(l.resizer)}return m}function b(l){if(!l.data.hasCaption){var m=e(l);l.resizer.on("mouseover",function(){"end"===l.data.alignment&&(l.data.align="right")});l.resizer.on("mouseout",function(){l.data.align="none"});l.on("data",function(){l.resizer["end"===l.data.alignment?
"addClass":"removeClass"]("cke_image_resizer_left")});if(l.wrapper.getChild(0).hasClass("cke_widget_element"))m&&l.element.append(m,!0);else{var r=g.document.createElement("span");r.addClass("cke_widget_element");m&&r.append(m);l.wrapper.append(r,!0);l.element=r;l.element.setAttribute("data-widget",l.name)}}}function f(l,m,r){l.data.imageStyle?m(l,"data-xwiki-image-style",l.data.imageStyle):r(l,"data-xwiki-image-style");l.data.border?m(l,"data-xwiki-image-style-border",l.data.border):r(l,"data-xwiki-image-style-border");
var q={left:"start",right:"end",center:"center"};l.data.alignment=l.data.alignment||q[l.data.align]||"none";l.data.align="none";l.data.alignment&&"none"!==l.data.alignment?m(l,"data-xwiki-image-style-alignment",l.data.alignment):r(l,"data-xwiki-image-style-alignment");l.data.textWrap?m(l,"data-xwiki-image-style-text-wrap",l.data.textWrap):r(l,"data-xwiki-image-style-text-wrap")}CKEDITOR.plugins.registered["xwiki-image-old"].overrideImageWidget(g,d);var n=d.init;d.init=function(){n.call(this);this.parts.caption?
this.setData("hasCaption",!0):this.setData("hasCaption",!1);var l=this.parts.image;this.data.hasCaption&&(l=this.element);this.setData("imageStyle",l.getAttribute("data-xwiki-image-style")||"");this.setData("border",l.getAttribute("data-xwiki-image-style-border"));this.setData("alignment",l.getAttribute("data-xwiki-image-style-alignment"));this.setData("textWrap",l.getAttribute("data-xwiki-image-style-text-wrap"));b(this);c(this)};var h=d.data;d.data=function(){f(this,function(l,m,r){l.parts.image.removeAttribute(m);
l.element.removeAttribute(m);l.data.hasCaption&&l.element.setAttribute(m,r);l.parts.image.setAttribute(m,r);l.wrapper.setAttribute(m,r)},function(l,m){l.element.removeAttribute(m);l.parts.image.removeAttribute(m);l.wrapper.removeAttribute(m)});(function(l){var m=l.element.hasAttribute("style")?l.element.getAttribute("style"):"";m=l.oldData&&l.oldData.width?m.split(";").filter(function(r){return-1===r.indexOf("width: "+l.oldData.width+"px")}).join(";"):l.data.width?m.split(";").filter(function(r){return-1===
r.indexOf("width: ")}).join(";"):m;m.endsWith(";")||(m+=";");";"===m&&(m="");l.data.hasCaption&&l.data.width&&(m=m+"width: "+l.data.width+"px;");""!==m&&l.element.setAttribute("style",m)})(this);h.call(this)};var a=d.upcast;d.upcast=function(l,m){var r=a.apply(this,arguments);if(r&&"img"===l.name){var q=new CKEDITOR.htmlParser.element("span");r.wrapWith(q);r=q}return r};var t=d.downcast;d.downcast=function(l){var m=this.data.alignment,r=t.apply(this,arguments);"p"===r.name&&"center"===m&&(m=CKEDITOR.tools.parseCssText(r.attributes.style||
""),"center"===m["text-align"]&&delete m["text-align"],CKEDITOR.tools.isEmpty(m)?r.attributes.style=void 0:r.attributes.style=CKEDITOR.tools.writeCssText(m));null===this.parts.caption&&(delete ("img"===r.name?r:r.findOne("img",!0)).attributes["data-widget"],r.children[0]&&(m=r.children[0],m.children[0]&&m.replaceWith(m.children[0])));delete r.attributes["data-widget"];return r}}})})();(function(){CKEDITOR.config["xwiki-link"]=CKEDITOR.config["xwiki-link"]||{__namespace:!0};var c=jQuery,k=/\bwiki(\w*)link\b/i,g={attach:"attachment",mailto:"external",unc:"external",url:"external"};CKEDITOR.plugins.add("xwiki-link",{requires:"xwiki-marker,xwiki-resource,xwiki-localization,balloontoolbar",init:function(q){q.plugins["xwiki-marker"].addMarkerHandler(q,"wikilink",{toHtml:function(p,u){if(1===u.length&&u[0].type===CKEDITOR.NODE_ELEMENT&&1===u[0].children.length&&"a"===u[0].children[0].name){var v=
u[0];u=v.children[0];v.replaceWithChildren();v=(k.exec(v.attributes["class"])||["",""])[1];u.attributes["data-linktype"]=v;p=p.value.substring(14);u.attributes["data-reference"]=CKEDITOR.tools.unescapeComment(p);1===u.children.length&&u.children[0].type===CKEDITOR.NODE_ELEMENT&&u.children[0].hasClass("wikigeneratedlinkcontent")&&(u.attributes["data-wikigeneratedlinkcontent"]=u.children[0].getHtml(),u.children[0].replaceWithChildren());u.hasClass("wikimodel-freestanding")&&(u.attributes["data-freestanding"]=
!0,u.removeClass("wikimodel-freestanding"))}else return!1},isMarked:function(p){return"a"===p.name&&p.attributes["data-reference"]},toDataFormat:function(p){var u=CKEDITOR.tools.escapeComment(p.attributes["data-reference"]);u=new CKEDITOR.htmlParser.comment("startwikilink:"+u);var v=new CKEDITOR.htmlParser.comment("stopwikilink");u.insertBefore(p);v.insertAfter(p);delete p.attributes["data-reference"];p.wrapWith(new CKEDITOR.htmlParser.element("span",{"class":"wiki"+(p.attributes["data-linktype"]||
"")+"link"}));delete p.attributes["data-linktype"];if(p.attributes["data-wikigeneratedlinkcontent"]===p.getHtml()){p.add(new CKEDITOR.htmlParser.element("span",{"class":"wikigeneratedlinkcontent"}),0);for(u=p.children[0];1<p.children.length;)v=p.children[1],v.remove(),u.add(v);"true"===p.attributes["data-freestanding"]&&p.addClass("wikimodel-freestanding")}delete p.attributes["data-wikigeneratedlinkcontent"];delete p.attributes["data-freestanding"]}});q.config.mentions=q.config.mentions||[];q.config.mentions.push({followingSpace:!0,
marker:"[",minChars:0,itemsLimit:6,feed:function(p,u){c.getJSON(q.config.sourceDocument.getURL("get",c.param({sheet:"CKEditor.LinkSuggestions",outputSyntax:"plain",language:XWiki.locale,input:p.query})),function(v){const x={id:"_uploadAttachment",iconClass:"fa fa-upload",iconURL:"",label:q.localization.get("xwiki-link.upload"),hint:q.localization.get("xwiki-link.uploadHint")};x.label.toLowerCase().startsWith(p.query.toLowerCase())&&(v=[x,...v]);u(v)})},itemTemplate:'<li data-id="{id}" class="ckeditor-autocomplete-item">\n            <div>\n              <span class="ckeditor-autocomplete-item-icon-wrapper"><img src="{iconURL}"/>\n                <span class="{iconClass}"></span>\n              </span>\n              <span class="ckeditor-autocomplete-item-label">{label}</span>\n            </div>\n            <div class="ckeditor-autocomplete-item-hint">{hint}</div>\n          </li>',
outputTemplate:function(p){return"_uploadAttachment"===p.id?(p="<script src="+`'${XWiki.contextPath}/${XWiki.servletpath}`+"skin/resources/uicomponents/suggest/suggestAttachments.js'defer='defer'>\x3c/script>",c(CKEDITOR.document.$).loadRequiredSkinExtensions(p),require(["xwiki-attachments-store","xwiki-file-picker","resource"],function(u,v,x){const w=function(y,z){const A=[];for(var E=0;E<y.length;E++){const G=y.item(E),B=new XWiki.EntityReference(G.name,XWiki.EntityType.ATTACHMENT,z);A.push(u.create(B,
G))}return A};v.pickLocalFiles({accept:"*",multiple:!1}).then(function(y){y=w(y,q.config.sourceDocument.documentReference);if(0!==y.length){var z=y[0];y=x.convertEntityReferenceToResourceReference(XWiki.Model.resolve(z.id,XWiki.EntityType.ATTACHMENT),q.config.sourceDocument.documentReference);q.insertHtml(c("<a></a>").attr({href:CKEDITOR.plugins.xwikiResource.getResourceURL(y,q),"data-reference":CKEDITOR.plugins.xwikiResource.serializeResourceReference(y)}).text(z.name).prop("outerHTML"));var A=new XWiki.widgets.Notification(q.localization.get("xwiki-link.uploadProgress",
z.name),"inprogress");y=XWiki.Model.resolve(z.id,XWiki.EntityType.ATTACHMENT);u.upload(y,z.file).then(()=>{A.replace(new XWiki.widgets.Notification(q.localization.get("xwiki-link.uploadSuccess",z.name),"done"))}).catch(()=>{A.replace(new XWiki.widgets.Notification(q.localization.get("xwiki-link.uploadError",z.name),"error"))})}})}),""):'<a href="{url}" data-reference="{typed}|-|{type}|-|{reference}">{label}</a>'}})},afterInit:function(q){CKEDITOR.plugins.link&&(r(q),q.ui.addButton("xwiki-link-open",
{label:q.localization.get("xwiki-link.openInNewTab"),command:"xwiki-link-open",toolbar:"xwiki-link"}),q.balloonToolbars.create({buttons:"xwiki-link-open,Link,Unlink",cssSelector:"a[href]"}))},onLoad:function(){d()}});var d=function(){var q=CKEDITOR.plugins.link;if(q){if("function"===typeof q.parseLinkAttributes){var p=q.parseLinkAttributes;q.parseLinkAttributes=function(v,x){v=p.call(q,v,x);if(x){var w=x.getAttribute("data-reference");if(w)v.resourceReference=CKEDITOR.plugins.xwikiResource.parseResourceReference(w);
else{w=x.getAttribute("href")||"";var y=0>w.indexOf("://")?"path":"url";v.resourceReference={type:y,reference:w}}if(x=x.getAttribute("data-wikigeneratedlinkcontent"))v.wikiGeneratedLinkContent=x}return v}}if("function"===typeof q.getLinkAttributes){var u=q.getLinkAttributes;q.getLinkAttributes=function(v,x){v=u.call(q,v,x);var w=x.resourceReference;w?(v.set["data-reference"]=CKEDITOR.plugins.xwikiResource.serializeResourceReference(w),v.set["data-linktype"]=g[w.type]||""):v.removed.push("data-reference",
"data-linktype");x.wikiGeneratedLinkContent?v.set["data-wikigeneratedlinkcontent"]=x.wikiGeneratedLinkContent:v.removed.push("data-wikigeneratedlinkcontent");return v}}}};CKEDITOR.on("dialogDefinition",function(q){if(q.editor.plugins["xwiki-link"]){var p=q.data.definition;if("link"===q.data.name){q=q.editor;var u=b(q);e(p,u);var v=p.getContents("info"),x=CKEDITOR.plugins.xwikiResource;x.bindResourcePicker(v.get("emailAddress"),["info",u.id],!0);var w=v.get("url");x.bindResourcePicker(w,["info",u.id]);
v.get("urlOptions").className="hidden";v.add(f(q),"urlOptions");p.minHeight=100;w=v.add;var y=n({id:"docQueryString"},"doc",q);var z=h("anchor",CKEDITOR.tools.extend({id:"docAnchor"},{label:q.localization.get("xwiki-link.anchor")}),"doc");w.call(v,{type:"vbox",id:"docOptions",children:[y,z]});v.add({type:"vbox",id:"attachOptions",children:[n({id:"attachQueryString"},"attach",q)]});l(v.get("emailSubject"),"subject","mailto");l(v.get("emailBody"),"body","mailto");delete p.onFocus;m(p);x.updateResourcePickerOnFileBrowserSelect(p,
["info",u.id],["upload","uploadButton"])}}});var e=function(q,p){var u=q.getContents("info").get("linkType");delete u.setup;CKEDITOR.plugins.xwikiDialog.replaceWith(q,"linkType",{type:"vbox",children:[p,u],onLoad:function(){this.getDialog().getContentElement("info","linkType").getElement().getParent().hide()}})},b=function(q){return CKEDITOR.plugins.xwikiResource.createResourcePicker({tabIndex:1,resourceTypes:(q.config["xwiki-link"]||{}).resourceTypes||["doc","attach","url","mailto"],getValue:function(){var p=
{resourceReference:this.base.getValue.apply(this,arguments)};this.getDialog().foreach(function(u){!0===u.resourceReferenceParameter&&"function"===typeof u.commit&&u.commit(p)});return p.resourceReference},setup:function(p){p=p.resourceReference||this.getDefaultResourceReference();"space"===p.type&&0>this.resourceTypes.indexOf("space")&&0<=this.resourceTypes.indexOf("doc")&&(p={type:"doc",typed:!0,reference:p.reference+".WebHome"});this.setValue(p)},commit:function(p){var u=this.getValue();"url"===
u.type&&u.reference&&0>u.reference.indexOf("://")&&(u.reference="https://"+u.reference);"boolean"!==typeof u.typed&&(u.typed="doc"!==u.type&&("url"!==u.type||0>u.reference.indexOf("://")));p.resourceReference=u},onResourceTypeChange:function(p,u){this.base.onResourceTypeChange.apply(this,arguments);var v=this.getDialog();v.setValueOf("info","linkType","mailto"===u.newValue?"email":"url");"attach"!==u.newValue&&v.hidePage("upload");this.resourceTypes.forEach(function(x){var w=v.getContentElement("info",
("mailto"===x?"email":x)+"Options");if(w){var y=w.getElement().getParent().getParent();x!==u.newValue||w.getElement().hasClass("hidden")?y.removeClass("linkOptions").hide():y.addClass("linkOptions")}});v.getContentElement("info","optionsToggle").sync();v.layout()},getDefaultResourceReference:function(){var p=(this.getDialog().getParentEditor().getSelection().getSelectedText()||"").trim().replace(/\s+/g," ");return{type:this.resourceTypes[0],reference:p,isNew:!0}}})},f=function(q){return{id:"optionsToggle",
type:"html",html:'<div class="linkOptionsToggle"><label class="cke_dialog_ui_labeled_label"><span class="arrow arrow-right"></span> '+CKEDITOR.tools.htmlEncode(q.localization.get("xwiki-link.options"))+"</label></div>",onLoad:function(){this.getElement().on("click",this.toggleLinkOptions,this)},toggleLinkOptions:function(p){p=this.getArrow();var u=this.getLinkOptions();p.hasClass("arrow-down")?(p.removeClass("arrow-down").addClass("arrow-right"),u.hide()):(p.removeClass("arrow-right").addClass("arrow-down"),
u.show())},sync:function(){var p=this.getArrow(),u=this.getLinkOptions();u?(this.getElement().show(),p.hasClass("arrow-down")?u.show():u.hide()):this.getElement().hide()},getArrow:function(){return this.getElement().findOne(".arrow")},getLinkOptions:function(){return this.getDialog().getElement().findOne(".linkOptions")}}},n=function(q,p,u){return h("queryString",CKEDITOR.tools.extend(q||{},{label:u.localization.get("xwiki-link.queryString")}),p)},h=function(q,p,u){return CKEDITOR.tools.extend(p||
{},{type:"text",resourceReferenceParameter:!0,setup:a(q,u),commit:t(q,u)})},a=function(q,p,u){return function(v){"function"===typeof u&&u.apply(this,arguments);var x=v.resourceReference||{};p&&p!==x.type||this.setValue((x.parameters||{})[q]||"")}},t=function(q,p,u){return function(v){var x=this.getValue().trim();""===x||p&&p!==v.resourceReference.type||(v.resourceReference.parameters=v.resourceReference.parameters||{},v.resourceReference.parameters[q]=x);"function"===typeof u&&u.apply(this,arguments)}},
l=function(q,p,u){q.resourceReferenceParameter=!0;q.setup=a(p,u,q.setup);q.commit=t(p,u,q.commit)},m=function(q){q=q.getContents("info").get("linkDisplayText");var p=q.setup,u=q.commit;CKEDITOR.tools.extend(q,{setup:function(v){"function"===typeof p&&p.apply(this,arguments);this.resourceReferenceField||(this.resourceReferenceField=this.getDialog().getContentElement("info","resourceReference"),c(this.resourceReferenceField.getElement().$).on("selectResource",this.maybeUpdateWikiGeneratedLinkContent.bind(this)));
this.wikiGeneratedLinkContent=v.wikiGeneratedLinkContent;delete this.validationRequest},validate:function(){if(this.validationRequest){if("pending"===this.validationRequest.state())return!1;delete this.validationRequest;return!0}this.validationRequest=this.validateAsync().always(function(){setTimeout(function(){this.getDialog().click("ok")}.bind(this),0)}.bind(this));return!1},validateAsync:function(){var v=this.resourceReferenceField.base.getValue.call(this.resourceReferenceField),x=(this.resourceReferenceField.selectedResource||
{}).reference||{},w={reference:v};x.type===v.type&&x.reference===v.reference&&(w=this.resourceReferenceField.selectedResource);return this.maybeUpdateWikiGeneratedLinkContent(null,w)},commit:function(v){"function"===typeof u&&u.apply(this,arguments);v.wikiGeneratedLinkContent=this.wikiGeneratedLinkContent},maybeUpdateWikiGeneratedLinkContent:function(v,x){var w=this.getValue();return""===w||w===this.wikiGeneratedLinkContent?this.maybeGetWikiGeneratedLinkContent(x).done(function(y){this.setValue(y);
this.wikiGeneratedLinkContent=y}.bind(this)).fail(function(){""===w&&this.setValue(this.getResourceLabel(x));delete this.wikiGeneratedLinkContent}.bind(this)):c.Deferred().resolve()},getResourceLabel:function(v){return v&&v.title||v&&v.entityReference&&v.entityReference.name||v&&v.reference&&v.reference.reference||this.getDialog().getParentEditor().localization.get("xwiki-link.defaultLabel")},maybeGetWikiGeneratedLinkContent:function(v){return(this.getDialog().getParentEditor().config["xwiki-link"]||
{}).autoGenerateLabels?this.getWikiGeneratedLinkContent(v):c.Deferred().reject()},getWikiGeneratedLinkContent:function(v){var x=function(){this.getDialog().setState(CKEDITOR.DIALOG_STATE_BUSY);var w=v&&v.reference||{},y=this.getDialog().getParentEditor().config["xwiki-link"]||{};return c.get(y.labelGenerator,w).then(function(z){return c(z).find(".wikigeneratedlinkcontent").text()}).always(function(){this.getDialog().setState(CKEDITOR.DIALOG_STATE_IDLE)}.bind(this))}.bind(this);return this.wikiGeneratedLinkContentRequest=
(this.wikiGeneratedLinkContentRequest||c.Deferred().resolve()).then(x,x)}},!0)},r=function(q){q.addCommand("xwiki-link-open",{exec:function(u){(u=p(u))&&(u=u.getAttribute("href"))&&window.open(u)}});"function"===typeof q.addMenuItem&&q.addMenuItem("xwiki-link-open",{label:q.localization.get("xwiki-link.openInNewTab"),command:"xwiki-link-open",group:"link",order:-1});q.contextMenu&&(q.contextMenu.addListener(function(u,v,x){if(u&&(u=p(q))&&u.getAttribute("href"))return{"xwiki-link-open":CKEDITOR.TRISTATE_OFF}}),
q.contextMenu._.panelDefinition.css.push(".cke_button__xwiki-link-open_icon {"+CKEDITOR.skin.getIconStyle("link")+"}"));var p=function(u){var v=CKEDITOR.plugins.link.getSelectedLink(u);u=u.widgets&&u.widgets.focused;!v&&u&&"image"==u.name&&u.parts.link&&(v=u.parts.link);return v}}})();(function(){CKEDITOR.plugins.add("xwiki-list",{requires:"xwiki-dialog,xwiki-localization"});CKEDITOR.on("dialogDefinition",function(c){if(c.editor.plugins["xwiki-list"]){var k=c.data.name,g=c.data.definition;("numberedListStyle"===k||"bulletedListStyle"===k)&&(k=CKEDITOR.plugins.xwikiDialog.getUIElementPath("type",g.contents))&&k.length&&(k=k[0].element.items,k.some(function(d){return"none"===d[1]})||k.push([c.editor.localization.get("xwiki-list.listType.none"),"none"]))}})})();(function(){CKEDITOR.plugins.add("xwiki-loading",{init:function(c){var k=0;c.setLoading=function(g){g?(k++,1===k&&this.fire("startLoading")):0<k&&(k--,0===k&&this.fire("endLoading"))};c.on("startLoading",function(g){this.editable()&&this.setReadOnly(!0);(g=this.ui.space("contents"))&&g.setStyle("visibility","hidden")});c.on("endLoading",function(g){(g=this.ui.space("contents"))&&g.removeStyle("visibility");var d=this.editable();d&&(d.hasFocus&&(d.$.blur(),setTimeout(function(){d.focus()},0)),this.setReadOnly(!1))})}})})();define("l10n",["module","jquery"],function(c,k){var g=function(b,f){b=k.param({prefix:b,key:f},!0);f=c.config();return(b.length>(f.getParamsLimit||1500)?k.post:k.get)(f.url,b)},d=function(b){var f=this[b];if("string"===typeof f)for(var n=1;n<arguments.length;n++)f=f.replace(new RegExp("\\{"+(n-1)+"\\}","g"),arguments[n]);else f=b;return f},e={get:d};return{load:function(b,f,n,h){f([b+"TranslationKeys"],function(a){c.config().url?g(b,a).done(function(t){t.get=d;n(t)}).fail(function(){n(e)}):n(e)})}}});(function(){CKEDITOR.plugins.add("xwiki-localization",{beforeInit:function(g){g.localization={get:function(d){return c.apply(g,arguments)}}}});var c=function(g){var d=k(this.lang,g);if("string"===typeof d)for(var e=1;e<arguments.length;e++)d=d.replace(new RegExp("\\{"+(e-1)+"\\}","g"),arguments[e]);else d=g;return d},k=function(g,d){if(d&&0<d.length){var e=d.indexOf("."),b=d.substr(0,e);e=d.substr(e+1);if(g&&g.hasOwnProperty(b))return k(g[b],e);if(g&&g.hasOwnProperty(d))return g[d]}else return g}})();define("macroEditorTranslationKeys",[],"title changeMacro submit descriptorRequestFailed installRequestFailed noParameters content more".split(" "));
define("macroParameterTreeBuilder",["jquery","l10n!macroEditor"],function(c,k){var g=function(b,f){var n={type:"group-multiple",data:c.extend({},f),children:[]};delete n.data.groups;c.each(f.groups,function(h,a){g(n,a)});b.children.push(n)},d=function(b,f,n){var h=f;Array.isArray(b.group)&&b.group.forEach(function(a){var t;a:{for(t=0;h.children&&t<h.children.length;t++){var l=h.children[t];if(l.data&&l.data.id===a){t=l;break a}}t=void 0}t||h.children.push({type:"group-multiple",data:{id:a,name:a,
children:[]}});h=t});h.children.push({type:"parameter",data:b})},e=function(b){var f={},n=[];b.children.forEach(function(h){h.children&&e(h);if(h.data&&h.data.feature){var a=f[h.data.feature];a||(f[h.data.feature]=a={type:"group-single",data:{feature:h.data.feature},children:[]},n.push(a));a.children.push(h)}else n.push(h)});b.children=n};return{build:function(b){var f={children:[]};c.each(b.groupDescriptorTree,function(a,t){g(f,t)});if(b.parameterDescriptorMap)for(var n in b.parameterDescriptorMap)if(b.parameterDescriptorMap.hasOwnProperty(n)){var h=
c.extend({},b.parameterDescriptorMap[n]);h.name=h.name||h.id;d(h,f,b)}b.contentDescriptor&&(h=c.extend({id:"$content",name:k.get("content")},b.contentDescriptor),d(h,f,b));e(f);return f}}});
define("macroParameterTreeSorter",["jquery"],function(c){var k=function(n,h,a){n.children?(n.data=c.extend({hidden:!0,mandatory:!1,value:!1,advanced:!0,index:Infinity},n.data),n.children.forEach(function(t){k(t,h,a);n.data.hidden=n.data.hidden&&!0===t.data.hidden;n.data.mandatory=n.data.mandatory||t.data.mandatory;n.data.value=n.data.value||t.data.hasOwnProperty("value")&&!1!==t.data.value;n.data.advanced=n.data.advanced&&!0===t.data.advanced;n.data.index=Math.min(n.data.index,t.data.index)}),n.children.sort(e),
f(n.children)):"parameter"===n.type&&(g(n.data,h),d(n.data,h,a))},g=function(n,h){"$content"===n.id?"string"===typeof h.content&&(n.value=h.content):(h=h.parameters[n.id.toLowerCase()],null!==h&&void 0!==h&&(n.value="object"===typeof h&&"string"===typeof h.name?h.value:h))},d=function(n,h,a){n.hidden=n.hidden&&void 0===n.value||n.deprecated&&void 0===n.value||0<=a.indexOf(n.id)&&!(n.mandatory&&("string"!==typeof n.value||0===n.value.length))},e=function(n,h){a:{n=n.data;h=h.data;for(var a=0;a<b.length;a++){var t=
b[a](n,h);if(0!==t){n=t;break a}}n=0}return n},b=[function(n,h){return h.hidden-n.hidden},function(n,h){return h.mandatory-n.mandatory},function(n,h){n=n.hasOwnProperty("value")&&!1!==n.value;return(h.hasOwnProperty("value")&&!1!==h.value)-n},function(n,h){return!!n.advanced-!!h.advanced},function(n,h){return n.index-h.index}],f=function(n){for(var h=0;h<n.length&&n[h].data.hidden;)h++;for(var a=h;a<n.length&&(n[a].data.mandatory||n[a].data.hasOwnProperty("value")&&!1!==n[a].data.value);)a++;for(;a<
n.length&&a<h+3&&!n[a].data.advanced;)a++;a===h&&(a=Math.min(n.length,h+3));a>h&&a<n.length?n.splice(a,0,{type:"more"}):0===n.length&&n.push({type:"empty"})};return{sort:k}});
define("macroParameterTreeDisplayer",["jquery","l10n!macroEditor"],function(c,k){var g=function(h){switch(h.type){case "group-multiple":var a=c('<li class="macro-parameter-group"><ul class="nav nav-tabs" role="tablist"><li class="active" role="presentation"><a class="macro-parameter-group-name" href="#groupId" aria-controls="groupId" role="tab"></a></li></ul><div class="tab-content"><ul id="groupId" class="macro-parameter-group-members tab-pane active" role="tabpanel"></ul></div></li>').addClass("multiple-choice");d(h,
a.find(".macro-parameter-group-name"),a.find(".macro-parameter-group-members"));b(a);return a;case "group-single":return e(h);case "parameter":return h=h.data,a=c('<li class="macro-parameter"><div class="macro-parameter-name"></div><div class="macro-parameter-description"></div></li>'),a.attr("data-id",h.id).attr("data-type",h.type),a.find(".macro-parameter-name").text(h.name),a.find(".macro-parameter-description").text(h.description),a.toggleClass("mandatory",!!h.mandatory),a.toggleClass("hidden",
!!h.hidden),a.append(f(h)),a;case "more":return c('<li class="more"><span class="arrow arrow-down"></span> <a href="#more"></a></li>').find("a").text(k.get("more")).end();case "empty":return c('<li class="empty"></li>').text(k.get("noParameters"))}},d=function(h,a,t){var l="macroParameterTreeNode-"+h.data.id;a.attr({href:"#"+l,"aria-controls":l}).text(h.data.name);a=h.children||[h];t.attr("id",l).append(a.map(g));1===a.length&&a[0].data&&a[0].data.name===h.data.name&&t.find(".macro-parameter-name").hide()},
e=function(h){var a=c('<li class="macro-parameter-group"><ul class="nav nav-tabs" role="tablist"><li class="active" role="presentation"><a class="macro-parameter-group-name" href="#groupId" aria-controls="groupId" role="tab"></a></li></ul><div class="tab-content"><ul id="groupId" class="macro-parameter-group-members tab-pane active" role="tabpanel"></ul></div></li>').addClass("single-choice").attr("data-feature",h.data.feature),t=a.find('ul[role="tablist"]'),l=t.children().remove(),m=a.find(".tab-content"),
r=m.children().remove();h.children.forEach(function(p,u){u=l.clone().appendTo(t);var v=r.clone().appendTo(m);u.add(v).removeClass("active").toggleClass("hidden",!!p.data.hidden);d(p,u.children().first(),v)});h=t.children().not(".hidden").first();var q=m.children().not(".hidden").first();h.add(q).addClass("active");b(a);return a},b=function(h){var a=h.find('ul[role="tablist"]').first().children().not(".hidden"),t=h.find(".tab-content").first().children().not(".hidden").first();h.toggleClass("invisible",
2>a.length&&2>t.children().not(".hidden").length)},f=function(h){var a=c("<div></div>").addClass("macro-parameter-field").html(h.editTemplate),t=a.find(":input").filter(function(){return c(this).attr("name")===h.id}),l=t.prop("type"),m=h.hasOwnProperty("value")?h.value:h.defaultValue,r=function(q){return function(){return h.caseInsensitive?c(this).val().toUpperCase()===q.toUpperCase():c(this).val()===q}};"checkbox"===l||"radio"===l?(t=t.filter(function(){return c(this).prop("type")===l}),h.caseInsensitive&&
(m=t.filter(r(m)).val()||m)):(t=t.first(),m&&t.is("select")&&(m="select-multiple"===t.prop("type")?m.split(","):[m],m.forEach(function(q,p){var u=t.find("option").filter(r(q));0<u.length?m[p]=u.val():c("<option></option>").val(q).text(q).appendTo(t)})));t.val(Array.isArray(m)?m:[m]);return a},n=function(h){h.preventDefault();h=c(this);h.nextAll().toggleClass("hidden");h=h.find(".arrow");h.hasClass("arrow-down")?h.removeClass("arrow-down").addClass("arrow-right"):h.removeClass("arrow-right").addClass("arrow-down")};
return{display:function(h,a){var t=c("<div></div>");t.append(h.children.map(g));t.find(".more").on("click",n).click();t.find('a[role="tab"]').on("click",function(l){l.preventDefault();c(this).tab("show")});c(document).loadRequiredSkinExtensions(a);return t.children()}}});
define("macroEditor","jquery modal l10n!macroEditor macroService macroParameterTreeBuilder macroParameterTreeSorter macroParameterTreeDisplayer bootstrap".split(" "),function(c,k,g,d,e,b,f){var n=function(m,r,q){if(this.prop("requestNumber")===m){m=c('<div><div class="macro-name"></div><div class="macro-description"></div><ul class="macro-parameters"></ul></div>');m.find(".macro-name").text(q.name);m.find(".macro-description").text(q.description);var p=e.build(q);b.sort(p,r,this.data("hiddenMacroParameters"));
m.find(".macro-parameters").append(f.display(p,q.requiredSkinExtensions));this.removeClass("loading").data("macroDescriptor",q).append(m.children());c(document).trigger("xwiki:dom:updated",{elements:this.toArray()});this.trigger("ready")}},h=function(m,r){this.prop("requestNumber")===m&&this.removeClass("loading").append('<div class="box errormessage">'+g.get(r,"<strong></strong>")+"</div>").find("strong").text(this.attr("data-macroId"))},a=function(m){var r={};m.find(":input").filter(function(){return 0===
c(this).parents(".macro-parameter-group-members").not(".active").length}).serializeArray().forEach(function(q){var p=r[q.name];void 0===p?r[q.name]=q.value:""!==q.value&&(Array.isArray(p)?p.push(q.value):r[q.name]=[p,q.value])});return r},t=function(m){return{focus:function(){m.find(":input").not(":hidden").first().focus()},getMacroCall:function(){var r=a(m);var q=m.data("macroDescriptor");if(q){var p={name:q.id.id,content:void 0,parameters:{}};"string"===typeof r.$content&&q.contentDescriptor&&(p.content=
r.$content);for(var u in r){var v=q.parameterDescriptorMap[u.toLowerCase()];if(v){var x=r[u];if(Array.isArray(x)){var w=v.type;x="boolean"===w||"java.lang.Boolean"===w?x[0]:x.join()}v=v.defaultValue;""===x||void 0!==v&&null!==v&&v+""===x||(p.parameters[u]=x)}}r=p}else r=null;return r},validate:function(){var r=this.getMacroCall(),q=m.find(".macro-parameter.mandatory ").filter(function(){var p=c(this).attr("data-id");p="$content"===p?r.content:r.parameters[p];return void 0===p||""===p});q.first().addClass("has-error").find(":input").not(":hidden").focus();
setTimeout(function(){q.first().removeClass("has-error")},1E3);return 0===q.length},update:function(r,q,p){var u=r.name;q&&(u+="/"+q);q=(m.prop("requestNumber")||0)+1;m.empty().addClass("loading").attr("data-macroId",u).prop("requestNumber",q);d.getMacroDescriptor(u,p).done(n.bind(m,q,r)).fail(h.bind(m,q,"descriptorRequestFailed"))}}},l=function(m,r){var q=r.data("macroEditorAPI");r.data("hiddenMacroParameters",m.hiddenMacroParameters||[]);var p=m.macroCall||{name:m.macroId,parameters:{}};p.name=
m.macroId||p.name;if(q)q.update(p,m.syntaxId,m.sourceDocumentReference);else{var u=c(this).find(".modal-footer .btn-primary");r.on("ready",function(v){q.focus();u.prop("disabled",!1)});q=r.xwikiMacroEditor(p,m.syntaxId)}};k=k.createModalStep({"class":"macro-editor-modal",title:g.get("title"),content:'<div class="macro-editor xform"></div>',acceptLabel:g.get("submit"),onLoad:function(){var m=this,r=m.find(".modal-footer .btn-primary");m.on("show.bs.modal",function(q){r.prop("disabled",!0)}).on("shown.bs.modal",
function(q){q=m.find(".macro-editor");var p=m.data("input");if(p.macroCategories&&p.macroCategories.includes("_notinstalled")){var u=p.macroId+""+p.syntaxId,v=(q.prop("requestNumber")||0)+1;q.empty().addClass("loading").attr("data-macroId",u).prop("requestNumber",v);d.installMacro(p.extensionId,p.extensionVersion).done(l.bind(this,p,q)).fail(h.bind(q,v,"installRequestFailed"))}else l.call(this,p,q)});r.on("click",function(q){var p=m.find(".macro-editor");q=p.xwikiMacroEditor();if(q.validate()){var u=
m.data("input");delete u.action;p=p.data("macroDescriptor");var v=(!u.macroCall||!1!==u.macroCall.inline)&&p.supportsInlineMode;u.macroCall=q.getMacroCall();u.macroCall.descriptor=p;u.macroCall.inline=v;m.data("output",u).modal("hide")}});c('<button type="button" class="btn btn-default pull-left"></button>').text(g.get("changeMacro")).prependTo(r.parent()).on("click",function(q){q=m.find(".macro-editor").xwikiMacroEditor();var p=m.data("input");p.action="changeMacro";var u=p.macroCall?p.macroCall.inline:
void 0;p.macroCall=q.getMacroCall();p.macroCall&&(p.macroCall.inline=u);m.data("output",p).modal("hide")})}});c.fn.xwikiMacroEditor=function(m,r,q){this.each(function(){var p=c(this);if(!p.data("macroEditorAPI")){var u=t(p);p.data("macroEditorAPI",u);u.update(m,r,q)}});return this.data("macroEditorAPI")};return k});define("macroSelectorTranslationKeys",[],"title filter.text.placeholder filter.category.placeholder filter.category.all filter.category.notinstalled filter.category.other failedToRetrieveMacros select recommended install install.confirm install.notAllowed".split(" "));
define("macroSelector",["jquery","modal","l10n!macroSelector","macroService","xwiki-selectize"],function(c,k,g,d){var e=function(m){var r=c('<ul class="macro-list form-control" tabindex="0"></ul>'),q=function(){var w={};m.forEach(function(y){y.categories.forEach(function(z){w[z.id]=w[z.id]||z})});return w}();m.forEach(function(w){var y=w.categories,z=c('<li data-macroCategories="" data-macroId="" data-extensionId="" data-extensionVersion="" data-extensionInstallAllowed=""><div><span class="macro-name"></span><span class="macro-extension"></span><span class="macro-categories-badges"></span></div><div class="macro-description"></div></li>').attr({"data-macroId":w.id.id,
"data-macroCategories":y.map(function(A){return A.id}).join(",")}).appendTo(r);z.find(".macro-name").text(w.name);w.extensionName&&(y=" - "+w.extensionName+" "+w.extensionVersion,z.find(".macro-extension").text(y),z.attr({"data-extensionId":w.extensionId,"data-extensionVersion":w.extensionVersion,"data-extensionName":w.extensionName,"data-extensionInstallAllowed":w.extensionInstallAllowed}));w.categories.forEach(function(A){z.find(".macro-categories-badges").append(c("<span>").addClass("badge").text(A.label))});
w.extensionRecommended&&z.find(".macro-categories-badges").append(c("<span>").addClass("badge").addClass("recommended").text(g.get("recommended")));z.find(".macro-description").text(w.description)});var p=c("<input/>").attr({type:"text","class":"macro-textFilter",placeholder:g.get("filter.text.placeholder")}),u=c("<div/>").addClass("macro-filters xform"),v=c("<select/>").addClass("macro-categories-field").attr("multiple",!0);u.append(c("<p/>").append(p)).append(c("<p/>").append(v));this.removeClass("loading").append(u).append(r);
var x=this;v.xwikiSelectize({preload:!0,placeholder:g.get("filter.category.placeholder"),persist:!0,onChange:function(){b.call(x)},load:function(w,y){y(Object.keys(q).filter(function(z){return-1!==z.toLowerCase().indexOf(w.toLowerCase())}).map(function(z){return{label:q[z].label,value:z}}))}});b.call(this)},b=function(){var m=c(this).find(".macro-textFilter").val().toLowerCase(),r=c(this).find(".macro-categories-field.selectized")[0].selectize.items,q=c(this).closest(".macro-selector");q.find(".macro-list").scrollTop(0).children().each(function(){var p=
c(this).find(".macro-name").text().toLowerCase(),u=c(this).find(".macro-description").text().toLowerCase(),v=c(this).attr("data-macroCategories").split(",");p=m&&m&&0>p.indexOf(m)&&0>u.indexOf(m)||0<r.length&&0<r.filter(function(x){return!v.includes(x)}).length;c(this).removeClass("selected").toggleClass("hidden",p)}).not(".hidden").first().addClass("selected");q.trigger("change")},f=function(m){var r=m.find(".macro-list .selected").map(function(){return c(this).attr("data-macroId")});0<r.length&&
m.trigger("xwiki:macro:selected",r)},n=function(m){m.preventDefault();m=c(this).parent("li");var r=c(this).closest(".macro-categories"),q=r.find(".dropdown-toggle"),p=m.attr("data-category"),u=q.attr("data-category");if(p!==u){var v=q.children(".caret").remove();q.text(m.find(".macro-category-name").text()+" ").append(v);"string"===typeof p?q.attr("data-category",p):q.removeAttr("data-category");r.trigger("change",p,u)}q.focus()},h=function(m){m.on("click",".macro-categories a",n);m.on("change",".macro-categories",
b.bind(m));var r;m.on("input",".macro-textFilter",function(){clearTimeout(r);r=setTimeout(b.bind(m),500)});m.on("click",".macro-list > li",function(){var q=c(this);q.addClass("selected").siblings().removeClass("selected");var p=q.position().top,u=q.parent();0>p?u.scrollTop(u.scrollTop()+p):(q=p+q.outerHeight()-u.height(),0<q&&u.scrollTop(u.scrollTop()+q));m.trigger("change")});m.on("keydown",".macro-textFilter, .macro-list",function(q){if(38===q.which||40===q.which){var p=m.find(".macro-list"),u=
38===q.which,v=u?"prev":"next",x=p.children(".selected");for(x=x.length?x[v]():p.children()[u?"last":"first"]();x.hasClass("hidden");)x=x[v]();x.click();q.preventDefault()}else 13===q.which&&f(m)});m.on("dblclick",".macro-list",function(){f(m)})},a=function(m,r){this.prop("requestNumber")===m&&(e.call(this,r),this.trigger("ready"))},t=function(m){this.prop("requestNumber")===m&&(m=c('<div class="box errormessage"></div>').text(g.get("failedToRetrieveMacros")),this.removeClass("loading").append(m))},
l=function(m){return{filter:function(r,q){m.find(".macro-textFilter").val(r);m.find(".macro-categories .dropdown-toggle").attr("data-category",q);b.call(m[0])},getSelectedMacro:function(){return m.find(".macro-list > li.selected").attr("data-macroId")},getSelectedMacroCategories:function(){return m.find(".macro-list > li.selected").attr("data-macroCategories").split(",")},getSelectedExtensionId:function(){return m.find(".macro-list > li.selected").attr("data-extensionId")},getSelectedExtensionVersion:function(){return m.find(".macro-list > li.selected").attr("data-extensionVersion")},
getSelectedExtensionName:function(){return m.find(".macro-list > li.selected").attr("data-extensionName")},getSelectedExtensionRecommended:function(){return"true"==m.find(".macro-list > li.selected").attr("data-extensionRecommended")},isInstalledMacro:function(){return!this.getSelectedMacroCategories().includes("_notinstalled")},isExtensionInstallAllowed:function(){return"false"!==m.find(".macro-list > li.selected").attr("data-extensionInstallAllowed")},reset:function(r){this.filter("");this.select(r)},
select:function(r){m.find(".macro-list > li").filter(function(){return c(this).attr("data-macroId")===r}).click()},update:function(r,q){r=r||m.attr("data-syntaxId");var p=(m.prop("requestNumber")||0)+1;m.empty().addClass("loading").attr("data-syntaxId",r).prop("requestNumber",p);d.getMacros(r,q).done(a.bind(m,p)).fail(t.bind(m,p))}}};k=k.createModalStep({"class":"macro-selector-modal",title:g.get("title"),content:'<div class="macro-selector loading"></div>',acceptLabel:g.get("select"),onLoad:function(){var m=
this,r=m.find(".modal-footer .btn-primary");m.on("shown.bs.modal",function(q){var p=m.data("input")||{},u=m.find(".macro-selector"),v=u.data("macroSelectorAPI");v?v.update(p.syntaxId,!0):(u.on("ready",function(){v=u.data("macroSelectorAPI");v.select(p.macroId);u.find(".macro-textFilter").focus()}).on("change",function(){v=u.data("macroSelectorAPI");var x=!v.getSelectedMacro();if(v.isInstalledMacro())var w=g.get("select");else if(w=g.get("install"),!v.isExtensionInstallAllowed()){var y=g.get("install.notAllowed");
x=!0}r.text(w);r.prop("title",y);r.prop("disabled",x)}).on("xwiki:macro:selected",function(x,w){r.click()}).attr("data-syntaxId",p.syntaxId),v=u.xwikiMacroSelector())});r.on("click",function(){var q=m.find(".macro-selector").xwikiMacroSelector(),p=q.getSelectedExtensionId(),u=q.getSelectedExtensionVersion(),v=q.getSelectedExtensionName();if(!p||window.confirm(g.get("install.confirm",v,u)))v=m.data("input")||{},v.macroId=q.getSelectedMacro(),v.macroCategories=q.getSelectedMacroCategories(),v.extensionId=
p,v.extensionVersion=u,m.data("output",v).modal("hide")})}});c.fn.xwikiMacroSelector=function(){this.each(function(){var m=c(this);if(!m.data("macroSelectorAPI")){var r=l(m);m.data("macroSelectorAPI",r);h(m);m.hasClass("loading")?r.update():m.trigger("ready")}});return this.data("macroSelectorAPI")};return k});define("macroService",["jquery","xwiki-meta"],function(c,k){var g={},d={};return{getMacroDescriptor:function(e,b){var f=c.Deferred(),n=g[e];n?f.resolve(n):(b=(new XWiki.Document(b||XWiki.currentDocument.documentReference)).getURL("get",c.param({outputSyntax:"plain",language:c("html").attr("lang"),sheet:"CKEditor.MacroService"})),c.get(b,{data:"descriptor",macroId:e}).done(function(h){"object"===typeof h&&null!==h?(g[e]=h,f.resolve(h)):f.reject.apply(f,arguments)}).fail(function(){f.reject.apply(f,
arguments)}));return f.promise()},installMacro:function(e,b){var f=(new XWiki.Document("MacroService","CKEditor")).getURL("get",c.param({outputSyntax:"plain",language:c("html").attr("lang")}));return c.post(f,{action:"install",extensionId:e,extensionVersion:b,form_token:k.form_token})},getMacros:function(e,b){var f=c.Deferred(),n=d[e||""];n&&!b?f.resolve(n):(b=(new XWiki.Document("MacroService","CKEditor")).getURL("get",c.param({outputSyntax:"plain",language:c("html").attr("lang")})),c.get(b,{data:"list",
syntaxId:e}).done(function(h){if("object"===typeof h&&Array.isArray(h.list)){var a=h.list;Array.isArray(h.notinstalled)&&(a=a.concat(h.notinstalled));d[e||""]=a;f.resolve(a)}else f.reject.apply(f,arguments)}).fail(function(){f.reject.apply(f,arguments)}));return f.promise()}}});define("macroWizard",["macroSelector","macroEditor"],function(c,k){var g=function(d){return"changeMacro"===d.action?(delete d.action,d.macroId=d.macroCall&&d.macroCall.name,c(d).then(k).then(g)):d.macroCall};return function(){var d={},e=0;if("object"===typeof arguments[e]&&null!==arguments[e]){var b=arguments[e];"object"===typeof b&&null!==b&&("string"===typeof b.name&&""!==b.name||"object"===typeof b.parameters&&null!==b.parameters||"string"===typeof b.content)?d.macroCall=arguments[e++]:d=arguments[e]}d.macroCall&&
(d.macroCall.parameters=d.macroCall.parameters||{});"string"===typeof arguments[e]&&(d.syntaxId=arguments[e]);if("string"!==typeof d.syntaxId||""===d.syntaxId)d.syntaxId=XWiki.docsyntax;return"object"===typeof d.macroCall&&null!==d.macroCall&&"string"===typeof d.macroCall.name&&""!==d.macroCall.name?k(d).then(g):c(d).then(k).then(g)}});(function(){var c=jQuery;CKEDITOR.config["xwiki-macro"]=CKEDITOR.config["xwiki-macro"]||{__namespace:!0};var k='<div class="macro" data-macro=""><div class="macro-placeholder">macro:name</div></div>'.replace(/div/g,"span"),g=function(e){var b;"function"===typeof e.getAttribute?b=e.getAttribute("data-xwiki-non-generated-content"):e.attributes&&(b=e.attributes["data-xwiki-non-generated-content"]);"string"===typeof b&&(b=b.replace(/\s+/g,""));return b};CKEDITOR.plugins.add("xwiki-macro",{requires:"widget,balloontoolbar,notification,xwiki-marker,xwiki-loading,xwiki-localization,xwiki-selection,xwiki-dialog",
init:function(e){var b=this,f=function(a){return a.type!==CKEDITOR.NODE_ELEMENT||CKEDITOR.dtd.$inline[a.name]},n=function(a,t){if(0<t.length){for(a=0;a<t.length&&f(t[a]);)a++;return a>=t.length}a:{t=[CKEDITOR.NODE_ELEMENT,CKEDITOR.NODE_TEXT];for(var l=a.getIndex()-1;0<=l;){var m=a.parent.children[l--];if(!t||0<=t.indexOf(m.type)){t=m;break a}}t=null}a:{l=[CKEDITOR.NODE_ELEMENT,CKEDITOR.NODE_TEXT];for(m=a.getIndex()+1;m<a.parent.children.length;){var r=a.parent.children[m++];if(!l||0<=l.indexOf(r.type)){l=
r;break a}}l=null}return t||l?t&&f(t)||l&&f(l):!CKEDITOR.dtd.$blockLimit[a.parent.name]},h=function(a){0<a.element.$.offsetHeight&&0<a.element.$.offsetWidth||c(a.element.$).children(".macro-placeholder.hidden").removeClass("hidden")};e.plugins["xwiki-marker"].addMarkerHandler(e,"macro",{toHtml:function(a,t){var l=n(a,t)?"span":"div",m=new CKEDITOR.htmlParser.element(l,{"class":"macro","data-macro":a.value}),r=!1;t.forEach(function(q){q.remove();m.add(q);r=r||("div"===q.name||"span"===q.name)&&q.hasClass("macro-placeholder")});
r||(t=new CKEDITOR.htmlParser.element(l,{"class":"macro-placeholder hidden"}),l=b.parseMacroCall(a.value),l=e.localization.get("xwiki-macro.placeholder",l.name),t.add(new CKEDITOR.htmlParser.text(l)),m.add(t,0));a.replaceWith(m)}});e.ui.addButton("xwiki-macro",{label:e.localization.get("xwiki-macro.buttonHint"),command:"xwiki-macro",toolbar:"insert,40"});e.widgets.add("xwiki-macro",{requiredContent:"div(macro,macro-placeholder)[data-macro];span(macro,macro-placeholder)[data-macro]",pathName:"macro",
upcast:CKEDITOR.plugins.xwikiMacro.isMacroElement,downcast:function(a){var t=new CKEDITOR.htmlParser.comment(a.attributes["data-macro"]),l=new CKEDITOR.htmlParser.comment("stopmacro"),m=new CKEDITOR.htmlParser.fragment;m.add(t);if(e.config.fullData)a.children.forEach(function(q){m.add(q)});else{var r=this;a.forEach(function(q){var p=g(q);if(p&&q.attributes.contenteditable){var u=r.getParameterType(q.attributes["data-xwiki-parameter-name"]);u&&p!==u||m.add(q);return!1}if(r.upcast(q))return!1},CKEDITOR.NODE_ELEMENT,
!0)}m.add(l);return m},getParameterType:function(a){var t=this.data.descriptor||{};void 0===a?t=t.contentDescriptor||{}:"string"===typeof a&&(t=(t.parameterDescriptorMap||{})[a.toLowerCase()]||{});return t.type},init:function(){b.initializeNestedEditables(this,e);if(e.container.isVisible())h(this);else e.once("focus",h.bind(null,this));var a=b.parseMacroCall(this.element.getAttribute("data-macro"));a.inline=this.inline;this.setData(a);if("true"!==this.element.getAttribute("data-xwiki-dom-updated"))this.once("ready",
function(){this.element.setAttribute("data-xwiki-dom-updated","true");c(e.document.$).trigger("xwiki:dom:updated",{elements:[this.element.$]})})},data:function(a){this.element.setAttribute("data-macro",b.serializeMacroCall(this.data));this.pathName=e.localization.get("xwiki-macro.placeholder",this.data.name);this.wrapper.data("cke-display-name",this.pathName);c(this.element.$).children(".macro-placeholder").text(this.pathName)},edit:function(a){a.cancel();this.showMacroWizard(this.data)},insert:function(a){var t=
(a.editor.getSelection().getSelectedText()||"").trim(),l=0<t.indexOf("\n")?!1:this.inline;this.showMacroWizard(c.extend({parameters:{},content:t,inline:l},a.commandData))},showMacroWizard:function(a){var t=this,l={macroCall:a,hiddenMacroParameters:Object.keys(t.editables||{}),sourceDocumentReference:e.config.sourceDocument.documentReference};require(["macroWizard"],function(m){m(l).done(function(r){b.insertOrUpdateMacroWidget(e,r,t)})})}});e.addCommand("xwiki-macro-insert",{async:!0,requiredContent:e.widgets.registered["xwiki-macro"].requiredContent,
exec:function(a,t){t=c.extend({parameters:{}},t);if(t.name){var l=this,m=a.on("afterCommandExec",function(r){"xwiki-refresh"===r.data.name&&(m.removeListener(),a.fire("afterCommandExec",{name:l.name,command:l}))});b.insertOrUpdateMacroWidget(a,t)}}});e.addCommand("xwiki-refresh",{async:!0,exec:function(a){var t=this;CKEDITOR.plugins.xwikiSelection.saveSelection(a);a.setLoading(!0);CKEDITOR.plugins.xwikiSource.convertHTML(a,{fromHTML:!0,toHTML:!0,text:a.getData()}).done(function(l,m,r){var q=r.getResponseHeader("X-XWIKI-HTML-HEAD");
require(["macroWizard"],function(){c(a.document.$).loadRequiredSkinExtensions(q)});a.setData(l,{callback:t.done.bind(t,!0)})}).fail(this.done.bind(this))},done:function(a){e.setLoading(!1);CKEDITOR.plugins.xwikiSelection.restoreSelection(e);a||e.showNotification(e.localization.get("xwiki-macro.refreshFailed"),"warning");e.fire("afterCommandExec",{name:this.name,command:this})}});((e.config["xwiki-macro"]||{}).insertButtons||[]).forEach(function(a){b.maybeRegisterDedicatedInsertMacroButton(e,a)});
require(["macroService","l10n!macroSelector"],function(a,t){e.addCommand("xwiki-macro-maybe-install-insert",{async:!0,exec:function(l,m){var r=this;a.getMacros(XWiki.docsyntax).done(function(q){q.forEach(function(p){if(p.id.id===m.id){var u=function(v){var x=l.on("afterCommandExec",function(w){var y=w.data.name;"xwiki-refresh"===w.data.name&&(x.removeListener(),l.fire("afterCommandExec",{name:y.name,command:y}))});a.getMacroDescriptor(p.id.id).done(function(w){for(var y in w.parameterDescriptorMap)if(w.parameterDescriptorMap[y].mandatory){v?
v.edit():l.execCommand("xwiki-macro",{name:p.id.id});return}y={name:p.id.id,parameters:{}};w.contentDescriptor&&w.contentDescriptor.mandatory&&(y.content=" ");b.insertOrUpdateMacroWidget(l,y,v)})};p.extensionId&&p.extensionName&&p.extensionVersion&&p.extensionInstallAllowed?window.confirm(t.get("install.confirm",p.extensionName,p.extensionVersion))?(l.widgets.once("instanceCreated",function(v){var x=l.showNotification(l.localization.get("xwiki-macro.installPending",p.extensionName,p.extensionVersion),
"progress",0);a.installMacro(p.extensionId,p.extensionVersion).done(function(){x.hide();l.showNotification(l.localization.get("xwiki-macro.installSuccessful",p.extensionName,p.extensionVersion),"success",5E3);a.getMacros(XWiki.docsyntax,!0);u(v.data)}).fail(function(){x.hide();l.localization.get("xwiki-macro.installFailed",p.extensionName,p.extensionVersion);l.fire("afterCommandExec",{name:r.name,command:r})})}),b.insertOrUpdateMacroWidget(l,{name:p.id.id,parameters:{}},void 0,!0)):(l.showNotification(l.localization.get("xwiki-macro.installFailed",
p.extensionName,p.extensionVersion),"warning",5E3),l.fire("afterCommandExec",{name:r.name,command:r})):u()}})})}})})},afterInit:function(e){e.addCommand("xwiki-macro-edit",{context:!0,contextSensitive:!0,startDisabled:!0,exec:function(b){this.getCurrentWidget(b).edit()},refresh:function(b,f){setTimeout(this._refresh.bind(this,b,f),0)},_refresh:function(b,f){(b=this.getCurrentWidget(b))&&"xwiki-macro"===b.name?this.enable():this.disable()},getCurrentWidget:function(b){return b.widgets.focused||b.widgets.widgetHoldingFocusedEditable}});
e.ui.addButton("xwiki-macro-edit",{label:e.localization.get("xwiki-macro.editButtonHint"),command:"xwiki-macro-edit",toolbar:"xwiki-macro"});e.balloonToolbars.create({buttons:"xwiki-macro-edit,xwiki-macro",cssSelector:"div.macro div.xwiki-metadata-container.cke_widget_editable"});require(["macroService","l10n!macroSelector"],function(b,f){var n={Notifications:"fa fa-bell",Content:"fa fa-align-left",Development:"fa fa-code",Formatting:"fa fa-list-alt",Navigation:"fa fa-sitemap",Layout:"fa fa-object-group",
Social:"fa fa-users",_fallback:"fa fa-cubes"};b.getMacros(XWiki.docsyntax).done(function(h){var a=0,t=function(l){var m={},r=l.categories.sort((q,p)=>{if(l.defaultCategory&&q.id!==p.id){if([q.id,q.label].includes(l.defaultCategory))return-1;if([p.id,p.label].includes(l.defaultCategory))return 1}return q.id.localeCompare(p.id)});m.group=r[0]&&r[0].id||"Macro";e.quickActions.getGroup(m.group)||(e.quickActions.addGroup({id:m.group,name:r[0].label||m.group,order:9E3+10*a}),a++);m.iconClass=n[r[0]&&r[0].id]||
n._fallback;r.forEach(function(q,p){m["badge"+p]=q.label});l.extensionRecommended&&(m["badge"+e.quickActions.config.maxBadges]=f.get("recommended"));return m};h.forEach(function(l){e.quickActions.getAction("macro-"+l.id.id)||l.categories.some(function(m){return"_notinstalled"===m.id})&&l.extensionVersion&&!l.extensionInstallAllowed||(l={id:"macro-"+l.id.id,name:l.name,description:l.description,...t(l),command:{name:"xwiki-macro-maybe-install-insert",data:{id:l.id.id}}},e.quickActions.addAction(l))})})})},
insertOrUpdateMacroWidget:function(e,b,f,n){e.fire("lockSnapshot",{dontUpdate:!0});var h=b.inline?"span":"div",a=f&&f.element;a&&f.element.getName()===h?f.setData(b):(this.createMacroWidget(e,b),"enforce"===b.inline&&!a&&e.widgets.focused&&(b=new CKEDITOR.dom.element("span"),b.setAttribute("id","xwiki-macro-inline-enforcer"),b.appendText(" "),b.insertAfter(e.widgets.focused.wrapper)));var t=e.on("afterCommandExec",function(l){if("xwiki-refresh"===l.data.name){t.removeListener();if(l=e.editable().findOne("span#xwiki-macro-inline-enforcer")){var m=
new CKEDITOR.dom.text(" ");m.insertAfter(l);var r=e.createRange();r.selectNodeContents(m);r.setStartAfter(m,r.endOffset);e.getSelection().selectRanges([r]);l.remove()}e.fire("unlockSnapshot")}});n||setTimeout(e.execCommand.bind(e,"xwiki-refresh"),0)},createMacroWidget:function(e,b){var f=e.widgets.registered["xwiki-macro"],n=CKEDITOR.dom.element.createFromHtml(b.inline?k:'<div class="macro" data-macro=""><div class="macro-placeholder">macro:name</div></div>'),h=e.widgets.wrapElement(n,f.name),a=new CKEDITOR.dom.documentFragment(h.getDocument());
a.append(h);e.widgets.initOn(n,f,b);e.widgets.finalizeCreation(a)},maybeRegisterDedicatedInsertMacroButton:function(e,b){if(b){if("string"===typeof b)b={macroCall:{name:b}};else if("object"!==typeof b||"object"!==typeof b.macroCall||null===b.macroCall||"string"!==typeof b.macroCall.name)return;b.commandId=b.commandId||"xwiki-macro-"+b.macroCall.name;for(var f=b.macroCall,n=b.macroCall.parameters||{},h,a=Object.keys(n),t=a.length,l={};t--;)h=a[t],l[h.toLowerCase()]=n[h];f.parameters=l;this.registerDedicatedInsertMacroButton(e,
b)}},registerDedicatedInsertMacroButton:function(e,b){e.addCommand(b.commandId,{exec:function(f){f.execCommand(b.insertDirectly?"xwiki-macro-insert":"xwiki-macro",b.macroCall)}});e.ui.addButton(b.commandId,{label:e.localization.get("xwiki-macro.dedicatedInsertButtonHint",b.macroCall.name),command:b.commandId,toolbar:"insert,50"})},initializeNestedEditables:function(e,b){b=(b.config["xwiki-macro"]||{}).nestedEditableTypes||{};for(var f=e.element.find("div[data-xwiki-non-generated-content]"),n=0;n<
f.count();n++){var h=f.getItem(n),a=h.getAscendant(this.isDomMacroElement.bind(this));if(e.element.equals(a)){a="$content";var t="div[data-xwiki-non-generated-content]:not([data-xwiki-parameter-name])";h.hasAttribute("data-xwiki-parameter-name")&&(a=h.getAttribute("data-xwiki-parameter-name"),t='div[data-xwiki-parameter-name="'+a+'"]');h=g(h);h=b[h]||{allowedContent:";"};e.initEditable(a,{selector:t,allowedContent:h.allowedContent,disallowedContent:h.disallowedContent,pathName:a})}}},isDomMacroElement:function(e){return("div"==
e.getName()||"span"==e.getName())&&e.hasClass("macro")&&e.hasAttribute("data-macro")},parseMacroCall:function(e){e=CKEDITOR.tools.unescapeComment(e);var b=11,f=e.indexOf("|-|",b);b={name:e.substring(b,f),parameters:{}};f=CKEDITOR.plugins.xwikiMarker.parseParameters(e,b.parameters,f+3,"|-|",!0);0<=f&&(b.content=e.substring(f+3));return b},serializeMacroCall:function(e){var b=["startmacro:",e.name,"|-|",CKEDITOR.plugins.xwikiMarker.serializeParameters(e.parameters)];"string"===typeof e.content&&b.push("|-|",
e.content);return CKEDITOR.tools.escapeComment(b.join(""))}});CKEDITOR.plugins.xwikiMacro={isMacroElement:function(e){return("div"==e.name||"span"==e.name)&&e.hasClass("macro")&&e.attributes["data-macro"]},isMacroOutput:function(e){return e.getAscendant&&e.getAscendant(function(b){if(CKEDITOR.plugins.xwikiMacro.isMacroElement(b))return!0;for(var f=0;b.previous&&0>=f;)b=b.previous,b.type===CKEDITOR.NODE_COMMENT&&("stopmacro"===b.value?f--:"startmacro:"===b.value.substr(0,11)&&f++);return 0<f})}};var d=
CKEDITOR.htmlParser.prototype.parse;CKEDITOR.htmlParser.prototype.parse=function(){var e=[{startMacro:0}],b=this.onComment;this.onComment=function(h){"stopmacro"===h?e[e.length-1].startMacro--:"startmacro:"===h.substring(0,11)&&e[e.length-1].startMacro++;return b.apply(this,arguments)};var f=this.onTagOpen;this.onTagOpen=function(h,a,t){var l=e[e.length-1];CKEDITOR.dtd.$removeEmpty[h]&&(0<l.startMacro||l.inMacroOutput&&!l.editable)&&(a["data-cke-survive"]=!0);e.push({startMacro:0,inMacroOutput:l.inMacroOutput||
0<l.startMacro,editable:l.editable&&0>=l.startMacro||"div"===h&&a["data-xwiki-non-generated-content"]});return f.apply(this,arguments)};var n=this.onTagClose;this.onTagClose=function(h){e.pop();return n.apply(this,arguments)};return d.apply(this,arguments)}})();(function(){CKEDITOR.plugins.add("xwiki-marker",{addMarkerHandler:function(c,k,g){var d="start"+k+":",e="stop"+k;if("function"===typeof g.toHtml)c.on("toHtml",function(h){b(h.data.dataValue,k).forEach(f)},null,null,7);var b=function(h,a){var t=[];h.forEach(function(l){if(l.value.substring(0,d.length)===d){for(var m=t.push,r=[],q=l.next,p=0;q&&(q.type!==CKEDITOR.NODE_COMMENT||q.value!==e||0<p);)q.type===CKEDITOR.NODE_COMMENT&&(q.value.substring(0,d.length)===d?p++:q.value===e&&p--),r.push(q),q=q.next;
m.call(t,{startComment:l,content:r,stopComment:q})}},CKEDITOR.NODE_COMMENT,!0);return t},f=function(h){!1!==g.toHtml(h.startComment,h.content)&&(h.startComment.parent&&h.startComment.remove(),h.stopComment&&h.stopComment.parent&&h.stopComment.remove())};if("function"===typeof g.toDataFormat&&"function"===typeof g.isMarked)c.on("toDataFormat",function(h){n(h.data.dataValue).forEach(g.toDataFormat)},null,null,14);var n=function(h){var a=[];h.forEach(function(t){g.isMarked(t)&&a.push(t)},CKEDITOR.NODE_ELEMENT,
!0);return a}}});CKEDITOR.tools.escapeComment=function(c){if("string"!==typeof c||0===c.length)return c;var k=[];">"===c.charAt(0)&&k.push("\\");for(var g="-",d=0;d<c.length;d++){var e=c.charAt(d);("\\"===e||"{"===e||"-"===e&&"-"===g)&&k.push("\\");k.push(e);g=e}"-"===g&&k.push("\\");return k.join("")};CKEDITOR.tools.unescape=function(c,k){if("string"!==typeof c||0===c.length)return c;for(var g=[],d=!1,e=0;e<c.length;e++){var b=c.charAt(e);d||b!==k?(g.push(b),d=!1):d=!0}return g.join("")};CKEDITOR.tools.unescapeComment=
function(c){return CKEDITOR.tools.unescape(c,"\\")};CKEDITOR.plugins.xwikiMarker={serializeParameters:function(c){var k=[],g;for(g in c)if(c.hasOwnProperty(g)){var d=c[g];null!==d&&void 0!==d&&k.push(this.serializeParameter(g,d))}return k.join(" ")},serializeParameter:function(c,k){c=k.name||c;var g=k;null!==k.value&&void 0!==k.value&&(g=k.value);k=g.toString().replace(/([\\"])/g,"\\$1");return c+'="'+k+'"'},parseParameters:function(c,k,g,d,e){for(var b=c.indexOf("=",g),f=c.indexOf(d,g);0<b&&(0>f||
b<f);){f=c.substring(g,b).trim();b=g=c.indexOf('"',b+1)+1;for(var n=!1;b<c.length&&(n||'"'!==c.charAt(b));)n=!n&&"\\"==c.charAt(b),b++;g=CKEDITOR.tools.unescape(c.substring(g,b),"\\");!0===e?k[f.toLowerCase()]={name:f,value:g}:k[f]=g;g=b+1;b=c.indexOf("=",g);f=c.indexOf(d,g)}return f}}})();(function(){var c=jQuery;CKEDITOR.plugins.add("xwiki-maximize",{requires:"maximize,xwiki-selection",init:function(g){g.on("beforeCommandExec",function(d){var e=d.data.command;if("maximize"===e.name){d=d.editor;e=e.state;var b=d.ui.space("bottom");b=c(b&&b.$);var f=c(d.element.$).closest("form"),n=f.find(".bottombuttons");f=f.find('input[name="x-maximized"]');var h=c(d.element.$).closest("body");e===CKEDITOR.TRISTATE_OFF?(h.attr("data-maximized","true"),n.find(".buttons").insertAfter(b),f.val("ckeditor#"+
d.name)):e===CKEDITOR.TRISTATE_ON&&(f.val(""),b.next().appendTo(n),h.removeAttr("data-maximized"))}});g.elementMode===CKEDITOR.ELEMENT_MODE_INLINE&&k(g)},afterInit:function(g){var d=g.element&&g.element.getAscendant("form");if(d&&(d=d.findOne('input[name="x-maximized"]'))&&"ckeditor#"===d.getValue().substr(0,9)&&d.getValue().substr(9)===g.name)g.once("instanceReady",function(e){g.execCommand("maximize")})}});var k=function(g){g.ui.addButton&&g.ui.addButton("Maximize",{label:g.lang.maximize.maximize,
command:"maximize",toolbar:"tools,10"});g.addCommand("maximize",{modes:{wysiwyg:!0,source:!0},readOnly:!0,editorFocus:!1,canUndo:!1,exec:function(){CKEDITOR.plugins.xwikiSelection.saveSelection(g);this.toggleState();var h=this.state===CKEDITOR.TRISTATE_ON,a=this.uiItems[0];if(a){var t=h?g.lang.maximize.minimize:g.lang.maximize.maximize;a=CKEDITOR.document.getById(a._.id);a.getChild(1).setHtml(t);a.setAttribute("title",t)}h?(d=g.on("beforeModeUnload",n.bind(null,g,!0)),e=g.on("mode",n.bind(null,g),
null,null,5),b=g.once("beforeDestroy",g.execCommand.bind(g,"maximize")),c(window).on("resize.maximize",n.bind(null,g)),c('<div class="cke_maximize_backdrop"></div>').appendTo(document.body)):f(g);c(document.getElementById("cke_"+g.name)).toggleClass("cke_toolBar_active",h);a:{for(t=c(g.container.$);t.length;){a=t.nextAll().find(".buttons");if(a.length){t=a;break a}t=t.parent()}t=void 0}t.toggleClass("cke_actionBar_active",h);n(g);g.fire("maximize",this.state);CKEDITOR.plugins.xwikiSelection.restoreSelection(g)}});
var d,e,b,f=function(h){[d,e,b].forEach(function(a){a.removeListener()});c(window).off("resize.maximize");c("body > div.cke_maximize_backdrop").remove();h.fire("blur");h.fire("focus")},n=function(h,a){var t=c(h.editable().$);!0!==a&&h.getCommand("maximize").state===CKEDITOR.TRISTATE_ON?(h=c(".cke_toolBar_active").outerHeight(),a=c(".cke_actionBar_active").outerHeight(),t.addClass("cke_editable_active").css({top:h,height:c(window).height()-h-a})):t.removeClass("cke_editable_active").css({top:"",height:""})}}})();define("officeImporterModal",["jquery","modal"],function(c,k){return k.createModalStep({"class":"office-importer-modal",onLoad:function(){var g=this,d=g.find(".modal-body"),e=g.find(".modal-footer .btn-primary");g.on("show.bs.modal",function(b){if(d.is(":empty")&&!d.hasClass("loading")){d.addClass("loading");var f=g.data("input").localization;e.text(f.get("xwiki-office.importer.import"));g.find(".modal-title").text(f.get("xwiki-office.importer.title"));b=g.data("input").formURL;c.get(b).done(function(n){d.html(n)}).fail(function(){var n=
c('<div class="box errormessage"></div>').text(f.get("xwiki-office.importer.failedToLoadForm"));d.empty().append(n)}).always(function(){d.removeClass("loading")})}});g.on("change",'input[name="filePath"]',function(b){e.prop("disabled",!c(b.target).val())});e.on("click",function(b){b={files:d.find('input[name="filePath"]')[0].files,filterStyles:d.find('input[name="filterStyles"]').prop("checked"),useOfficeViewer:d.find('input[name="useOfficeViewer"]').prop("checked")};b.files&&0<b.files.length&&g.data("output",
b).modal("hide")})}})});
(function(){var c=jQuery;CKEDITOR.config["xwiki-office"]=CKEDITOR.config["xwiki-office"]||{__namespace:!0};CKEDITOR.plugins.add("xwiki-office",{requires:"uploadwidget,notification,xwiki-localization,xwiki-macro,xwiki-dialog",init:function(k){k.config["xwiki-office"]=c.extend({enabled:!1,importer:k.config.sourceDocument.getURL("get",c.param({sheet:"CKEditor.OfficeImporter",language:c("html").attr("lang")||""}))},k.config["xwiki-office"]);this.initOfficeImporter(k);k.config.applyPasteFilterAfterPasteFromWord&&this.applyPasteFilterAfterPasteFromWord(k)},
applyPasteFilterAfterPasteFromWord:function(k){k.on("afterPasteFromWord",function(g){var d=k.pasteFilter;if(d){var e=CKEDITOR.htmlParser.fragment.fromHtml(g.data.dataValue),b=new CKEDITOR.htmlParser.basicWriter;d.applyTo(e);e.writeHtml(b);g.data.dataValue=b.getHtml()}})},initOfficeImporter:function(k){var g=this,d=k.config["xwiki-office"];k.ui.addButton("officeImporter",{label:k.localization.get("xwiki-office.importer.title"),icon:"pastefromword",command:"officeImporter",toolbar:"insert,50"});k.addCommand("officeImporter",
{async:!0,contextSensitive:!1,startDisabled:!d.enabled,exec:function(e){var b=this;require(["officeImporterModal"],function(f){f({formURL:d.importer,localization:e.localization}).done(function(n){g.importOfficeFile(e,n)}).always(function(){e.fire("afterCommandExec",{name:b.name,command:b})})})}});CKEDITOR.fileTools.addUploadWidget(k,"uploadOfficeFile",{onUploaded:function(e){var b=k.showNotification(k.localization.get("xwiki-office.importer.inProgress"),"progress"),f=this;c.get(d.importer,{fileName:e.fileName,
filterStyles:e.file.filterStyles,useOfficeViewer:e.file.useOfficeViewer,outputSyntax:"plain"}).done(function(n,h,a){var t=a.getResponseHeader("X-XWIKI-HTML-HEAD");require(["macroWizard"],function(){c(k.document.$).loadRequiredSkinExtensions(t)});f.replaceWith(n);b.update({message:k.localization.get("xwiki-office.importer.done"),type:"success"})}).fail(function(){b.update({message:k.localization.get("xwiki-office.importer.fail"),type:"warning"});k.widgets.del(f)})}})},importOfficeFile:function(k,g){var d=
CKEDITOR.fileTools,e=d.getUploadUrl(k.config);if(e){var b=g.files[0];b.filterStyles=g.filterStyles;b.useOfficeViewer=g.useOfficeViewer;g=k.uploadRepository.create(b);b=k.document.createElement("div");b.appendText(k.localization.get("xwiki-office.importer.inProgress"));d.markElement(b,"uploadOfficeFile",g.id);d.bindNotifications(k,g);k.insertElement(b);k.widgets.initOn(b);g.upload(e)}else k.showNotification(k.localization.get("xwiki-office.importer.noUploadURL"),"warning")}})})();define("entityResourceDisplayer",["jquery","resource"],function(c,k){var g=function(d,e,b){if(e.hasClass("breadcrumb")){var f=b.resolve;e.addClass("resource-hint");var n=e.find(".active").remove();n=n.has("a").length?n.find("a"):c("<span></span>").text(n.text());n.addClass("resource-label");d=c('<span class="resource-icon"></span>').addClass(k.types[d.type].icon);var h=c('<span class="glyphicon glyphicon-remove remove"></span>');e.find(".wiki").first().remove();e=c("<div></div>").append(d).append(document.createTextNode(" ")).append(n).append(document.createTextNode(" ")).append(h).add(e);
f.call(b,e)}else b.reject()};k.displayers.doc=function(d){var e=c.Deferred();c.post(XWiki.currentDocument.getURL("get"),{language:c("html").attr("lang"),xpage:"hierarchy_reference",reference:d.reference,limit:5}).done(function(b){g(d,c(b),e)}).fail(function(){e.reject()});return e.promise()};k.displayers.attach=function(d){var e=c.Deferred(),b=k.convertResourceReferenceToEntityReference(d);c.post(XWiki.currentDocument.getURL("get"),{language:c("html").attr("lang"),xpage:"hierarchy_reference",reference:XWiki.Model.serialize(b.parent),
limit:4}).done(function(f){var n=c('<li class="attachment active"><a></a></li>'),h=(new XWiki.Document(b.parent)).getURL("download")+"/"+encodeURIComponent(b.name);n.find("a").attr("href",h).text(b.name);f=c(f);f.find(".active").removeClass("active").after(n);g(d,f,e)}).fail(function(){e.reject()});return e.promise()}});define("entityResourcePickerTranslationKeys",[],["select","doc.title","attach.title"]);
define("entityResourcePicker",["jquery","resource","modal","l10n!entityResourcePicker","xwiki-tree"],function(c,k,g,d){var e=function(r){return c(document.createElement("div")).attr(c.extend({"class":"ckeditor-tree jstree-no-links","data-edges":!0,"data-finder":!0,"data-icons":!0,"data-responsive":!0},r))},b=function(r,q){var p=r.find(".ckeditor-tree"),u=r.find(".modal-footer .btn-primary"),v=function(x){x=x.get_selected(!0);for(var w=0;w<x.length;w++)if(!q.canSelect(x[w]))return!1;return 0<x.length};
r.on("shown.bs.modal",function(x){var w=q.openToNodeId;"string"===typeof w&&w!==r.data("openTo")?r.data("openTo",w):w=!1;x=c.jstree.reference(p);x?w&&(x.deselect_all(),x.close_all(),x.openTo(w)):x=p.xtree({core:{multiple:"true"===p.data("multiple")}}).one("ready.jstree",function(y,z){w&&z.instance.openTo(w)}).on("changed.jstree",function(y,z){u.prop("disabled",!v(z.instance))}).on("dblclick",".jstree-anchor",function(y){v(c.jstree.reference(this))&&u.click()})});u.on("click",function(){r.modal("hide");
var x=c.jstree.reference(p);q.select(x.get_selected(!0))});q.open=function(x){this.openToNodeId=x;r.modal()};return q},f=function(r){var q=r.text,p=r.id.indexOf(":");var u=r.id.substr(0,p);r=r.id.substr(p+1);u=XWiki.Model.resolve(r,XWiki.EntityType.byName(u));return{title:q,reference:u}},n=function(r){return XWiki.EntityType.getName(r.type)+":"+XWiki.Model.serialize(r)},h=function(r){var q=r.extractReference(XWiki.EntityType.DOCUMENT);q||(q=r.extractReference(XWiki.EntityType.SPACE),q||(r=r.extractReference(XWiki.EntityType.WIKI)||
new XWiki.WikiReference(XWiki.currentWiki),q=new XWiki.EntityReference("Main",XWiki.EntityType.SPACE,r)),q=new XWiki.EntityReference("WebHome",XWiki.EntityType.DOCUMENT,q));return q},a=function(r,q){var p=b(r,{canSelect:function(u){return(u.data||{}).type===q.entityType},select:function(u){q.select(u.map(f))}});q.open=function(u){var v=p.open,x=XWiki.EntityType.byName(q.entityType),w=u.extractReference(x);u=w?n(w):x===XWiki.EntityType.DOCUMENT?n(h(u)):x===XWiki.EntityType.ATTACHMENT?"attachments:"+
XWiki.Model.serialize(h(u)):n(u);v.call(p,u)};return q},t=function(r,q){var p=function(u){return a(r,{entityType:k.types[q.resourceType].entityType,select:function(v){q.select(v.map(function(x){return c.extend({},x,{reference:k.convertEntityReferenceToResourceReference(x.reference,u),entityReference:x.reference})}))}})};q.open=function(u,v){p(v).open(k.convertResourceReferenceToEntityReference(u,v))};return q},l={doc:(new XWiki.Document("DocumentTree","XWiki")).getURL("get",c.param({outputSyntax:"plain",
language:c("html").attr("lang"),showAttachments:!1,showTranslations:!1,showWikis:!0})),attach:(new XWiki.Document("DocumentTree","XWiki")).getURL("get",c.param({outputSyntax:"plain",language:c("html").attr("lang"),showTranslations:!1,showWikis:!0}))},m=function(r,q){q=g.createModal({"class":"entity-resource-picker-modal",title:q,content:e({"data-url":l[r]}),acceptLabel:d.get("select")});var p=t(q,{resourceType:r});k.pickers[r]=function(u,v){var x=c.Deferred();p.select=function(w){x.resolve(w[0])};
p.open(u,v);return x.promise()}};"function"===typeof c.fn.xtree&&(m("doc",d.get("doc.title")),m("attach",d.get("attach.title")))});define("entityResourceSuggesterTranslationKeys",[],["doc.placeholder","attach.placeholder"]);
define("entityResourceSuggester",["jquery","resource","l10n!entityResourceSuggester"],function(c,k,g){var d=function(f,n,h,a,t){c.post((new XWiki.Document("SuggestSolrService","XWiki")).getURL("get"),{outputSyntax:"plain",language:c("html").attr("lang"),query:f.join("\n"),input:n,nb:8}).done(function(l){if(l.documentElement){l=l.getElementsByTagName("rs");for(var m=[],r=0;r<l.length;r++){var q=m,p=q.push;var u=l.item(r);var v=t;var x=u.childNodes[0].nodeValue;var w=u.getAttribute("type");var y=u.getAttribute("id");
w=XWiki.Model.resolve(y,XWiki.EntityType.byName(w));u=u.getAttribute("info");v={reference:k.convertEntityReferenceToResourceReference(w,v),entityReference:w,title:x,location:u};p.call(q,v)}h.resolve(m)}else h.resolve([])}).fail(function(){h.resolve([])})},e=function(f){var n=c('<span class="resource-label"><span class="resource-icon"></span> </span><span class="resource-hint"></span>');n.find(".resource-icon").addClass(k.types[f.reference.type].icon);n.first().append(document.createTextNode(f.title)).next().html(f.location);
n.last().text(function(h,a){return" / "===a.substr(0,3)?a.substr(3):a});return n},b=/[+\-!(){}\[\]\^"~*?:\\]+/;k.types.doc.placeholder=g.get("doc.placeholder");k.suggesters.doc={retrieve:function(f,n){var h=c.Deferred(),a=["q=__INPUT__","fq=type:DOCUMENT"];(f=f.reference.trim())?(a.push("qf=title^2 name"),b.test(f)||(a[0]="q=(__INPUT__)^2 __INPUT__*")):(f="*:*",a.push("sort=date desc"));d(a,f,h,XWiki.EntityType.DOCUMENT,n);return h.promise()},display:e};k.types.attach.placeholder=g.get("attach.placeholder");
k.suggesters.attach={retrieve:function(f,n){var h=c.Deferred(),a=["q=__INPUT__","fq=type:ATTACHMENT"];(f=f.reference.trim())?(a.push("qf=filename"),b.test(f)||(a[0]="q=(__INPUT__)^2 __INPUT__*")):(f="*:*",a.push("sort=attdate_sort desc"));d(a,f,h,XWiki.EntityType.ATTACHMENT,n);return h.promise()},display:e}});(function(){const c=jQuery;let k;CKEDITOR.config["xwiki-resource"]=CKEDITOR.config["xwiki-resource"]||{__namespace:!0};CKEDITOR.plugins.add("xwiki-resource",{requires:"xwiki-marker,xwiki-dialog,xwiki-localization",onLoad:function(){require(["resource","resourcePicker.bundle"],function(d){k=d})},init:function(d){d.config["xwiki-resource"]=c.extend({dispatcher:d.config.sourceDocument.getURL("get",c.param({sheet:"CKEditor.ResourceDispatcher",outputSyntax:"plain",language:c("html").attr("lang")||""}))},
d.config["xwiki-resource"])}});CKEDITOR.plugins.xwikiResource={parseResourceReference:function(d){var e=d.split("|-|");d={typed:"true"===e[0],type:e[1],reference:e[2],parameters:{}};3<e.length&&(e=e.slice(3).join("|-|"),CKEDITOR.plugins.xwikiMarker.parseParameters(e,d.parameters));if("mailto"===d.type&&(e=d.reference.lastIndexOf("?"),0<=e)){var b=d.reference.substr(e+1);d.reference=d.reference.substr(0,e);CKEDITOR.tools.extend(d.parameters,g(b),!0)}return d},serializeResourceReference:function(d){var e=
[!!d.typed,d.type,d.reference],b=d.parameters;if("mailto"===d.type&&0>d.reference.indexOf("?")){b=CKEDITOR.tools.extend({},b);var f={};["subject","body"].forEach(function(n){var h=b[n];null!==h&&void 0!==h&&(f[n]=h);delete b[n]});d=c.param(f);0<d.length&&(e[2]+="?"+d.replace(/\+/g,"%20"))}(d=CKEDITOR.plugins.xwikiMarker.serializeParameters(b))&&e.push(d);return e.join("|-|")},createResourcePicker:function(d){var e={id:"resourceReference",type:"html",html:'<div><label class="cke_dialog_ui_labeled_label"></label><input type="text" /></div>',
tabIndex:0,onLoad:function(){var b=this.getBase();c(this.getElement().$).on("changeResourceType",this.onResourceTypeChange.bind(this)).find("input").resourcePicker({resourceTypes:this.resourceTypes,base:b});c(this.getElement().$).on("selectResource",this.onSelectResource.bind(this));var f=this.getElement().findOne(".dropdown-toggle"),n=this.getElement().findOne("button.resourceType");b=this.getElement().findOne("input.resourceReference");var h=this.tabIndex;[f,n,b].forEach(function(a){var t=this;
0<=h&&h<t._.focusList.length?(t.addFocusable(a,h),a._focusable=t._.focusList[h]):(t.addFocusable(a),a._focusable=t._.focusList[t._.focusList.length-1]);a.on("focus",function(){t._.currentFocusIndex=this._focusable.focusIndex})},this.getDialog());f=CKEDITOR.tools.getNextId();b.setAttribute("id",f);this.getElement().findOne("label").setAttribute("for",f)},validate:function(){var b=this.getValue();return""===b.reference&&!0!==(k.types[b.type]||{}).allowEmptyReference?this.getDialog().getParentEditor().localization.get("xwiki-resource.notSpecified",
this.getLabelElement().getText()):!0},getValue:function(){var b=this.getResourcePickerInput();c(b.$).trigger("beforeGetValue");b=b.getValue();var f=b.indexOf(":");b={type:b.substr(0,f),reference:b.substr(f+1)};this.selectedResource&&this.selectedResource.reference.type===b.type&&this.selectedResource.reference.reference===b.reference&&(b.typed=this.selectedResource.reference.typed);return b},setValue:function(b){b=b||{type:this.resourceTypes[0],reference:"",isNew:!0};var f=(b.type||"")+":"+(b.reference||
"");c(this.getResourcePickerInput().$).val(f).trigger("selectResource",{reference:b})},getBase:function(){var b=CKEDITOR.currentInstance;if(b)var f=b.config.sourceDocument.documentReference;return f},getResourcePickerInput:function(){return this.getElement().findOne("input")},getLabelElement:function(){return this.getElement().findOne(".cke_dialog_ui_labeled_label")},onResourceTypeChange:function(b,f){b=k.types[f.newValue]||{label:f.newValue};this.getLabelElement().setText(b.label)},onSelectResource:function(b,
f){this.selectedResource=f}};d=d||{};d.base=e;return CKEDITOR.tools.extend(d,e)},getResourceURL:function(d,e){if(0<=["url","path","unc","unknown"].indexOf(d.type))return d.reference;if(0<=["mailto","data"].indexOf(d.type))return d.type+":"+d.reference;e=e.config["xwiki-resource"].dispatcher;e+=0>e.indexOf("?")?"?":"&";return e+c.param(d)},updateResourcePickerOnFileBrowserSelect:function(d,e,b){if((d=d.getContents(b[0]).get(b[1]))&&d.filebrowser){b=d.filebrowser;"string"===typeof b&&(b={target:b},
d.filebrowser=b);var f=b.onSelect;b.onSelect=function(n,h){h.resourceReference&&this.getDialog().setValueOf(e[0],e[1],h.resourceReference);if("function"===typeof f)return f.call(this,n,h)}}},bindResourcePicker:function(d,e,b,f){var n=f||function(a){return a},h=d.commit;d.commit=function(){var a=this.getDialog().getValueOf(e[0],e[1]);!0===b?this.setValue(n(a.reference,b,this.getDialog(),e)):(a=CKEDITOR.plugins.xwikiResource.getResourceURL(a,this.getDialog().getParentEditor()),this.setValue(n(a,b,this.getDialog(),
e)));"function"===typeof h&&h.apply(this,arguments)};delete d.validate;d.hidden=!0}};var g=function(d){var e={};d=d.replace(/\+/g," ");d.split("&").forEach(function(b){var f=b.split("=");b=decodeURIComponent(f[0]);f=1<f.length?decodeURIComponent(f[1]):"";e[b]=f});return e}})();define("resourceTranslationKeys",[],"attach.label attach.placeholder data.label doc.label doc.placeholder icon.label mailto.label mailto.placeholder path.label path.placeholder unc.label unc.placeholder unknown.label url.label url.placeholder user.label user.placeholder".split(" "));
define("resource",["l10n!resource"],function(c){var k={attach:{label:c.get("attach.label"),icon:"glyphicon glyphicon-paperclip",placeholder:c.get("attach.placeholder"),entityType:"attachment"},data:{label:c.get("data.label"),icon:"glyphicon glyphicon-briefcase",placeholder:"image/png;base64,AAAAAElFTkSuQmCC"},doc:{label:c.get("doc.label"),icon:"glyphicon glyphicon-file",placeholder:c.get("doc.placeholder"),allowEmptyReference:!0,entityType:"document"},icon:{label:c.get("icon.label"),icon:"glyphicon glyphicon-flag",
placeholder:"help"},mailto:{label:c.get("mailto.label"),icon:"glyphicon glyphicon-envelope",placeholder:c.get("mailto.placeholder")},path:{label:c.get("path.label"),icon:"glyphicon glyphicon-road",placeholder:c.get("path.placeholder")},unc:{label:c.get("unc.label"),icon:"glyphicon glyphicon-hdd",placeholder:c.get("unc.placeholder")},unknown:{label:c.get("unknown.label"),icon:"glyphicon glyphicon-question-sign",placeholder:""},url:{label:c.get("url.label"),icon:"glyphicon glyphicon-globe",placeholder:c.get("url.placeholder")},
user:{label:c.get("user.label"),icon:"glyphicon glyphicon-user",placeholder:c.get("user.placeholder")}},g=["wiki","space","doc","attach"];return{types:k,pickers:{},suggesters:{},displayers:{},convertEntityReferenceToResourceReference:function(d,e){e=e||XWiki.currentDocument.getDocumentReference();var b=g[d.type];e=d.relativeTo(e);var f=d;for(var n=e;n.parent;)f=f.parent,n=n.parent;if(f.parent&&f.parent.type===f.type)if(d.type===XWiki.EntityType.DOCUMENT)d="."+XWiki.Model.serialize(e);else{do f=f.parent;
while(f.parent&&f.parent.type===f.type);e=f.parent;delete f.parent;d=XWiki.Model.serialize(d);f.parent=e}else d=XWiki.Model.serialize(e);return{type:b,typed:!0,reference:d}},convertResourceReferenceToEntityReference:function(d,e){e=e||XWiki.currentDocument.getDocumentReference();var b=XWiki.EntityType.byName(k[d.type].entityType);return XWiki.Model.resolve(d.reference,b,e)}}});define("resourcePickerTranslationKeys",[],["attach.hint","doc.hint"]);
define("resourcePicker",["jquery","resource","l10n!resourcePicker","bootstrap3-typeahead"],function(c,k,g){var d=function(p){var u=k.types[p]||{label:p,icon:"glyphicon glyphicon-question-sign"};this.find(".input-wrapper").attr("class","input-group").children(".input-group-btn").show();var v=this.find(".resourceTypes");if(1===v.children().length){var x=v.next(".resourceType");x.prependTo(x.parent()).nextAll().show()}c('<li><a href="#"><span class="icon"></span></a></li>').appendTo(v).find("a").attr({"data-id":p,"data-placeholder":u.placeholder}).children(".icon").addClass(u.icon).after(document.createTextNode(" "+
u.label))},e=function(p){p.on("click",".resourceTypes a",b).on("changeResourceType",m).on("changeResourceType",r);var u=p.find("button.resourceType");u.on("click",f);var v=p.find(".resourceDisplay"),x=p.find("input.resourceReference");v.on("click",".remove",function(w){v.addClass("hidden").empty();x.change()});v.on("click","a",function(w){w.preventDefault()});x.on("change",function(w){v.hasClass("hidden")&&p.prev("input").val(u.val()+":"+x.val())});p.on("keydown","input.resourceReference",function(w){13===
w.which&&c(w.target).change()});p.prev("input").on("beforeGetValue",function(){x.change()})},b=function(p){p.preventDefault();p=c(this);var u=p.closest(".resourcePicker"),v=u.find("button.resourceType"),x=v.val(),w=p.attr("data-id");if(w!==x){v.val(w);var y="function"!==typeof k.pickers[w];v.prop("disabled",y);y?(v.attr("title",p.text().trim()),v.attr("disabled","disabled")):v.attr("title",g.get(w+".hint"));v.find(".icon").attr("class",p.find(".icon").attr("class"));u.find(".resourceReference").attr("placeholder",
p.attr("data-placeholder"));u.trigger("changeResourceType",{oldValue:x,newValue:w})}},f=function(p){var u=c(this);p=u.closest(".resourcePicker");var v=a(p.prev("input"));v.type!==u.val()&&(v={type:u.val(),reference:p.find("input.resourceReference").val()});u=(p.data("options")||{}).base;k.pickers[v.type](v,u).done(n.bind(p))},n=function(p){this.prev("input").val(p.reference.type+":"+p.reference.reference).trigger("selectResource",p)},h=function(p,u){u=u||{reference:a(c(p.target))};p=c(p.target).nextAll("div.resourcePicker").first();
t(p,u.reference.type);l(p,u.reference)},a=function(p){var u=p.val(),v=u.indexOf(":"),x=u.substr(0,v);u=u.substr(v+1);0===x.length&&(0===u.length&&(x=p.next(".resourcePicker").find(".resourceTypes a").first().attr("data-id")),x=x||"unknown");return{type:x,reference:u,isNew:0>v&&0===u.length}},t=function(p,u){var v=p.find(".resourceType");u!==v.val()&&(v=p.find("a").filter(function(){return c(this).attr("data-id")===u}),0===v.length&&(d.call(p,u),v=p.find("a").filter(function(){return c(this).attr("data-id")===
u})),v.click())},l=function(p,u){var v=p.find(".resourceReference"),x=p.find(".resourceDisplay");p=k.displayers[u.type];"function"===typeof p&&!u.isNew&&(0<u.reference.length||k.types[u.type].allowEmptyReference)?(v.val(""),x.empty().addClass("loading").removeClass("hidden"),p(u).done(function(w){x.empty().removeClass("loading").attr({"data-resourceType":u.type,"data-resourceReference":u.reference}).append(w).removeClass("hidden")}).fail(function(){v.val(u.reference);x.addClass("hidden")})):(x.addClass("hidden").empty(),
v.val(u.reference))},m=function(p,u){p=c(this);var v=p.find(".resourceDisplay");v.attr("data-resourceType")!==u.newValue||v.is(":empty")?(v.addClass("hidden"),p.find("input.resourceReference").change()):(v.removeClass("hidden"),p.prev("input").val(v.attr("data-resourceType")+":"+v.attr("data-resourceReference")))},r=function(p,u){p=c(this);var v=p.find("input.resourceReference");v.typeahead("destroy");var x=k.suggesters[u.newValue];if(x){var w=(p.data("options")||{}).base;v.on("keydown",q).typeahead({afterSelect:n.bind(p),
delay:500,displayText:function(y){var z=new String(y.reference.reference);z.__resource=y;return z},highlighter:!x.display||function(y){return x.display(y.__resource)},matcher:function(y){return!0},minLength:0,sorter:function(y){return y},source:function(y,z){x.retrieve({type:u.newValue,reference:y},w).done(z)}})}else v.off("keydown",q)},q=function(p){(27===p.which||13===p.which)&&0<c(this).next(".dropdown-menu").filter(":visible").length&&p.stopPropagation()};c.fn.resourcePicker=function(p){return this.each(function(){if(!c(this).next().is("div.resourcePicker")){var u=
c(this),v=p;v=v||{};var x=c('<div class="resourcePicker"><div class="input-group"><input type="text" class="resourceReference" /><div class="input-group-btn"><button type="button" class="resourceType btn btn-default"><span class="icon"></button><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button><ul class="resourceTypes dropdown-menu dropdown-menu-right"></ul></div></div><div class="resourceDisplay"></div></div>');x.data("options",
v);u.on("selectResource",h).hide().after(x);v=c(u).attr("data-resourceTypes")||v.resourceTypes||[];"string"===typeof v&&(v=v.split(/\s*,\s*/));if(0===v.length)x.find(".input-group").attr("class","input-wrapper").children(".input-group-btn").hide();else if(1===v.length){var w=x.find(".resourceType");w.appendTo(w.parent()).prevAll().hide()}v.forEach(d,x);e(x);u.trigger("selectResource")}})}});
define("resourcePicker.bundle",["resourcePicker","entityResourcePicker","entityResourceSuggester","entityResourceDisplayer"],function(){});(function(){var c=jQuery;CKEDITOR.config["xwiki-save"]=CKEDITOR.config["xwiki-save"]||{__namespace:!0};CKEDITOR.plugins.add("xwiki-save",{requires:"notification,xwiki-cache,xwiki-localization",editors:[],init:function(k){var g=this.getContentTypeField(k);if(!1===k._.xwikiCache[g.attr("name")]||g.prop("disabled"))g.prop("disabled",!0),k.config.startupMode="source";this.editors.push(k);k.on("destroy",function(d){d=this.editors.indexOf(k);0<=d&&this.editors.splice(d,1)}.bind(this));this.addEditFormShortcutKey(k,
"cancel",CKEDITOR.ALT+67);this.addEditFormShortcutKey(k,"preview",CKEDITOR.ALT+80);this.addEditFormShortcutKey(k,"saveAndContinue",CKEDITOR.ALT+CKEDITOR.SHIFT+83);this.addEditFormShortcutKey(k,"save",CKEDITOR.ALT+83)},onLoad:function(){c(document).on("xwiki:actions:beforePreview xwiki:actions:beforeSave",function(g,d){this.updateFormFields()||(g.preventDefault(),d&&d.originalEvent&&"function"===typeof d.originalEvent.stop&&d.originalEvent.stop())}.bind(this));var k=!1;c(document).on("xwiki:actions:cancel xwiki:actions:preview xwiki:actions:save xwiki:document:saved",
function(g,d){d&&d["continue"]||(k="xwiki:actions:preview"===g.type||"xwiki:actions:save"===g.type,this.editors.forEach(function(e){e.focusManager?.hasFocus&&e.focusManager?._?.timer&&e.focusManager.blur(!0);e.resetDirty()}))}.bind(this));c(window).on("beforeunload",function(g){k?k=!1:this.updateFormFields(!0);var d=this.checkDirty();if(d)return g.returnValue=d.localization.get("xwiki-save.leaveConfirmationMessage"),g.returnValue}.bind(this))},updateFormFields:function(k){var g=!0;k=!0===k;this.editors.forEach(function(d){d.elementMode!==
CKEDITOR.ELEMENT_MODE_REPLACE||this.updateContent(d,k)||(g=!1);this.updateContentType(d)},this);return g},updateContent:function(k,g){if(g){var d=k.config.fullData;k.config.fullData=!0}try{return k.updateElement()}catch(e){return k.showNotification(k.localization.get("xwiki-save.failed"),"warning"),console.log(e),!1}finally{g&&(k.config.fullData=d)}},updateContentType:function(k){var g=this.getContentTypeField(k),d="source"===k.mode;g.prop("disabled",d);k._.xwikiCache[g.attr("name")]=!d;g.nextAll().filter(function(){return c(this).attr("name")===
g.val()+"_syntax"}).val(k.config.sourceSyntax)},getContentTypeField:function(k){var g=k.element&&k.element.getNameAtt();return c("input[name=RequiresHTMLConversion]").filter(function(){return c(this).val()===g})},checkDirty:function(){for(var k=0;k<this.editors.length;k++){var g=this.editors[k];if((g.config["xwiki-save"]||{}).leaveConfirmation&&g.checkDirty())return g}return!1},addEditFormShortcutKey:function(k,g,d){var e="xwiki-"+g;k.addCommand(e,{canUndo:!1,context:!1,contextSensitive:!1,editorFocus:!1,
exec:function(b){var f=(b.config["xwiki-save"]||{})[g+"Button"]||"input[name=action_"+g.toLowerCase()+"]";c(b.container.$).closest("form, .form, body").find(f).click()},modes:{wysiwyg:1}});k.setKeystroke(d,e)}})})();(function(){var c=jQuery;CKEDITOR.plugins.xwikiSelection={saveSelection:function(d){var e=d.editable();if(e){var b=d.getSelection();if(b&&b.isFake){var f=b.document.$.defaultView.getSelection();f.removeAllRanges();b.getRanges().map(k).forEach(f.addRange.bind(f))}d._.textSelection=CKEDITOR.plugins.xwikiSelection.textSelection.from(e.$)}else delete d._.textSelection},restoreSelection:function(d){var e=d.editable(),b=d._.textSelection;if(e&&b){d.focus();b.applyTo(e.$);if(e=d.widgets)a:{if(e=d.getSelection(!0))for(e=
e.getNative(),b=0;b<e.rangeCount;b++){var f;var n=void 0;var h=e.getRangeAt(b),a=d;var t=c(h.startContainer).closest("[contenteditable]");var l=c(h.endContainer).closest("[contenteditable]");if((f="false"===t.attr("contenteditable"))&&!(f=t[0]===l[0])){f=t[0];var m=f.ownerDocument.createRange();m.setStartAfter(f);m.setEnd(h.endContainer,h.endOffset);f=g(m)}if(f)n=t[0];else{if(t="false"===l.attr("contenteditable"))t=l[0],f=t.ownerDocument.createRange(),f.setStart(h.startContainer,h.startOffset),f.setEndBefore(t),
t=g(f);t&&(n=l[0])}if(n=n&&a.widgets.getByElement(new CKEDITOR.dom.element(n),!0)){e=n;break a}}e=void 0}e?(e.wrapper.scrollIntoView(),(e.editables.$content||e).focus()):d.selectionChange()}}};CKEDITOR.plugins.add("xwiki-selection",{onLoad:function(){require(["textSelection"],function(d){CKEDITOR.plugins.xwikiSelection.textSelection=d})}});var k=function(d){var e=d.startContainer.$.ownerDocument.createRange();e.setStart(d.startContainer.$,d.startOffset);e.setEnd(d.endContainer.$,d.endOffset);return e},
g=function(d){for(;!d.collapsed;)if(0===d.endOffset)d.setEndBefore(d.endContainer);else break;for(var e=!1;!d.collapsed;)if("string"===typeof d.startContainer.nodeValue)if(d.startOffset===d.startContainer.nodeValue.length)d.setStartAfter(d.startContainer);else break;else if(d.startOffset===d.startContainer.childNodes.length)d.setStartAfter(d.startContainer);else if(e||d.startOffset!==d.startContainer.childNodes.length-1||"br"!==d.startContainer.lastChild.nodeName.toLowerCase())break;else d.setStartAfter(d.startContainer),
e=!0;return d.collapsed}})();define("node-module",["jquery"],function(c){return{load:function(k,g,d,e){c.get(g.toUrl(k+".js"),function(b){d.fromText("define(function(require, exports, module) {"+b+"});")},"text")}}});
define("textSelection",["jquery","node-module!fast-diff","scrollUtils"],function(c,k,g){var d=function(f){return"function"===typeof f.setSelectionRange},e=function(f,n){var h=0,a=f.ownerDocument.createNodeIterator(f,NodeFilter.SHOW_TEXT,function(l){return NodeFilter.FILTER_ACCEPT},!1);do{var t=a.nextNode();h+=t?t.nodeValue.length:0}while(t&&h<n);return t?{node:t,offset:n-(h-t.nodeValue.length)}:{node:f,offset:0<n?f.childNodes.length:0}},b=function(f,n){for(var h=0,a=n,t=0;t<f.length&&h<n;t++){var l=
f[t];0>l[0]?(a=h+l[1].length>n?a-(n-h):a-l[1].length,h+=l[1].length):0<l[0]?a+=l[1].length:h+=l[1].length}return a};return{from:function(f){var n=c.extend;a:if(d(f))f={text:f.value,startOffset:f.selectionStart,endOffset:f.selectionEnd};else{var h=f.ownerDocument.defaultView.getSelection();if(h&&0<h.rangeCount){h=h.getRangeAt(0);var a=h.commonAncestorContainer;a.nodeType!==Node.ELEMENT_NODE&&(a=a.parentNode);if(f.contains(a)){a=f.ownerDocument.createRange();a.setStartBefore(f);a.setEnd(h.startContainer,
h.startOffset);a=a.toString().length;f={text:f.textContent,startOffset:a,endOffset:a+h.toString().length};break a}}f={text:f.textContent,startOffset:0,endOffset:0}}return n.call(c,{},this,f)},applyTo:function(f){var n=d(f)?this.withText(f.value):this.withText(f.textContent).asRange(f);if(d(f)){var h=f.value;f.value=h.substring(0,n.endOffset);f.scrollTop=f.scrollHeight;var a=f.scrollHeight>f.clientHeight;f.value=h;a&&(f.scrollTop+=f.clientHeight/2);f.setSelectionRange(n.startOffset,n.endOffset)}else h=
n.startContainer,h.nodeType!==Node.ELEMENT_NODE&&(h=h.parentNode),g.centerVertically(h,65),f=f.ownerDocument.defaultView.getSelection(),f.removeAllRanges(),f.addRange(n)},withText:function(f){if(this.text===f)return this;var n=c.extend,h=k(this.text,f),a=b(h,this.startOffset);h=this.endOffset===this.startOffset?a:b(h,this.endOffset);return n.call(c,{},this,{text:f,startOffset:a,endOffset:h})},asRange:function(f){var n=e(f,this.startOffset),h=this.endOffset===this.startOffset?n:e(f,this.endOffset);
f=f.ownerDocument.createRange();f.setStart(n.node,n.offset);f.setEnd(h.node,h.offset);return f}}});
define("scrollUtils",["jquery"],function(c){var k=function(b){for(b=b.parentNode;b&&(b.nodeType!==Node.ELEMENT_NODE||!g(b));)b=b.parentNode;return b},g=function(b){var f=c(b).css("overflow-y");return b.scrollHeight>b.clientHeight+4&&"hidden"!==f&&("visible"!==f||b===b.ownerDocument.documentElement||b===b.ownerDocument.body)},d=function(b,f){var n=f.scrollTop;f.scrollTop=0;b=c(b).offset().top-c(f).offset().top;f.scrollTop=n;return b},e=function(b,f,n){return n>=b.scrollTop+f&&n<=b.scrollTop+b.clientHeight-
f};return{getVerticalScrollParent:k,hasVerticalScrollBar:g,getRelativeTopOffset:d,isCenteredVertically:e,centerVertically:function(b,f){var n=k(b);n&&(b=d(b,n),f&&e(n,f,b)||(n.scrollTop=b-n.clientHeight/2))}}});(function(){class c{constructor(a){this.config=Object.assign({defaultAction:{group:"",id:"",name:"",description:"",iconClass:"",iconURL:"",shortcut:""},defaultGroup:{id:"",name:"",order:Infinity},maxBadges:3},a);this.config.search=Object.assign({includeScore:!0,threshold:.25,keys:[{name:"id",weight:5},{name:"nameTokens",weight:4},{name:"descriptionTokens",weight:2},{name:"group.id",weight:1},{name:"group.nameTokens",weight:1}]},this.config.search);this.config.defaultAction=Object.assign(Array(this.config.maxBadges).fill().map(function(t,
l){return l}).reduce(function(t,l){return{...t,["badge"+(l+1)]:""}},{}),this.config.defaultAction);this.actions=[];this.groups={};this.searchReady=new Promise(function(t,l){require(["fuse"],function(m){t(new m(this.actions,this.config.search))}.bind(this),l)}.bind(this))}addActions(){for(var a=0;a<arguments.length;a++)Array.isArray(arguments[a])?this.addActions.apply(this,arguments[a]):this.addAction(arguments[a])}addAction(a){a=Object.assign({},this.config.defaultAction,a);a.nameTokens=a.name.split(/\s+/);
a.descriptionTokens=a.description.split(/\s+/);var t=Object.hasOwn(this.groups,a.group)?this.groups[a.group]:"string"===typeof a.group?this.addGroup({id:a.group,name:a.group}):this.addGroup(a.group);a.group=t;return this.searchReady.then(function(l){l.add(a)}).catch(function(l){console.error("Failed to initialize quick action search because: "+l);this.actions.push(a)}.bind(this))}getAction(a){for(var t of this.actions)if(t.id===a)return t}addGroups(){for(var a=0;a<arguments.length;a++)Array.isArray(arguments[a])?
this.addGroups.apply(this,arguments[a]):this.addGroup(arguments[a])}addGroup(a){a=Object.assign({},this.config.defaultGroup,a);a.nameTokens=(a.name||"").split(/\s+/);return this.groups[a.id]=a}getGroup(a){return this.groups[a]}search(a){return a.length?this.searchReady.then(function(t){return t.search(a)}):Promise.resolve(this.actions.slice())}sort(a){if(a.length&&a[0].score){var t=a.reduce(function(m,r){m[r.item.group.id]=m[r.item.group.id]||[];m[r.item.group.id].push(r);return m},{}),l={};Object.entries(t).forEach(function(m){l[m[0]]=
m[1].reduce(function(r,q){return Math.min(r,q.score)},Infinity)});return a.sort(function(m,r){return m.item.group.id===r.item.group.id?m.score-r.score:l[m.item.group.id]-l[r.item.group.id]}).map(function(m){return m.item})}return a.sort(function(m,r){return m.group.id===r.group.id?0:m.group.order-r.group.order})}}const k=CKEDITOR.plugins.autocomplete,g=k.view,d=CKEDITOR.tools.copy(k.prototype),e=CKEDITOR.tools.copy(g.prototype);Object.assign(k.prototype,{attach:function(){d.attach.apply(this,arguments);
this.view.element.setAttribute("aria-label",this.view.editor.localization.get("xwiki-slash.dropdown.hint"))},open:function(){d.open.apply(this,arguments);this.view.element.setAttribute("data-query",this.model.query)},getHtmlToInsert:function(...a){return b(()=>d.getHtmlToInsert.apply(this,a))},getTextWatcher:function(...a){const t=d.getTextWatcher.apply(this,a);this.editor.on("afterInsertHtml",function(){t.check(!1)});return t}});Object.assign(g.prototype,{getItemById:function(...a){a[0]=CSS.escape(a[0]);
return e.getItemById.apply(this,a)},createItem:function(...a){return b(()=>e.createItem.apply(this,a))}});const b=function(a){const t=CKEDITOR.tools.htmlEncode;try{return CKEDITOR.tools.htmlEncode=function(l){return t(l).replace(/"/g,"&quot;").replace(/'/g,"&#39;")},a()}finally{CKEDITOR.tools.htmlEncode=t}},f=function(a){return CKEDITOR.tools.array.reduce(CKEDITOR.tools.object.keys(a),function(t,l){t[l]=CKEDITOR.tools.htmlEncodeAttr(a[l]);return t},{})},n=function(a){g.call(this,a)};n.prototype=CKEDITOR.tools.prototypedCopy(g.prototype);
Object.assign(n.prototype,{open:function(){CKEDITOR.dom.document.prototype.hasAttribute=function(){return!1};return g.prototype.open.apply(this,arguments)},close:function(){delete CKEDITOR.dom.document.prototype.hasAttribute;return g.prototype.close.apply(this,arguments)},updateItems:function(a){var t=new CKEDITOR.dom.documentFragment(this.document),l;a.forEach(function(m){m.group&&l!==m.group.id&&(l=m.group.id,t.append(this.createGroup(m.group)));t.append(this.createItem(m))}.bind(this));this.appendItems(t);
this.selectedItemId=null},createGroup:function(a){a=f(a);return CKEDITOR.dom.element.createFromHtml(this.groupTemplate.output(a),this.document)}});const h=function(a,t){t=Object.assign({},{textTestCallback:function(l){return l.collapsed?CKEDITOR.plugins.textMatch.match(l,function(m,r){if(m=m.slice(0,r).match(new RegExp(t.marker.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+".{0,30}$")))return{start:m.index,end:r}}):null}},t);k.call(this,a,t);this.view.groupTemplate=new CKEDITOR.template(t.groupTemplate||
'<li data-group="{id}" class="ckeditor-autocomplete-group" title="{name}"><h6>{name}</h6></li>')};h.prototype=CKEDITOR.tools.prototypedCopy(k.prototype);Object.assign(h.prototype,{getView:function(){return new n(this.editor)},getHtmlToInsert:function(a){this.maybeScheduleCommand(a);return a.outputHTML||""},maybeScheduleCommand:function(a){var t=a.command||{};"string"===typeof t&&(t={name:t});t.name&&setTimeout(function(){this.editor.execCommand(t.name,t.data)}.bind(this),0)}});CKEDITOR.plugins.AdvancedAutoComplete=
h;CKEDITOR.plugins.AdvancedAutoComplete.View=n;CKEDITOR.plugins.add("xwiki-slash",{requires:"autocomplete,xwiki-focusedplaceholder",beforeInit:function(a){a.quickActions=new c;["p","li","td"].forEach(t=>{a.config["xwiki-focusedplaceholder"].placeholder[t]||(a.config["xwiki-focusedplaceholder"].placeholder[t]="xwiki-slash.placeholder")})},init:function(a){a.quickActions.addGroups([{id:"Layout",name:a.localization.get("xwiki-slash.group.Layout"),order:100},{id:"Content",name:a.localization.get("xwiki-slash.group.Content"),
order:200},{id:"Formatting",name:a.localization.get("xwiki-slash.group.Formatting"),order:300},{id:"Navigation",name:a.localization.get("xwiki-slash.group.Navigation"),order:500},{id:"Actions",name:a.localization.get("xwiki-slash.group.Actions"),order:600},{id:"Table",name:a.localization.get("xwiki-slash.group.Table"),order:700},{id:"Macro",name:a.localization.get("xwiki-slash.group.Macro"),order:800}]);a.quickActions.addActions([{group:"Layout",id:"h1",name:a.lang.format.tag_h1,iconClass:"fa fa-header",
description:a.localization.get("xwiki-slash.action.h1.hint"),command:{name:"xwiki-applyStyle",data:{element:"h1"}}},{group:"Layout",id:"h2",name:a.lang.format.tag_h2,iconClass:"fa fa-header",description:a.localization.get("xwiki-slash.action.h2.hint"),command:{name:"xwiki-applyStyle",data:{element:"h2"}}},{group:"Layout",id:"h3",name:a.lang.format.tag_h3,iconClass:"fa fa-header",description:a.localization.get("xwiki-slash.action.h3.hint"),command:{name:"xwiki-applyStyle",data:{element:"h3"}}},{group:"Layout",
id:"h4",name:a.lang.format.tag_h4,iconClass:"fa fa-header",description:a.localization.get("xwiki-slash.action.h4.hint"),command:{name:"xwiki-applyStyle",data:{element:"h4"}}},{group:"Layout",id:"h5",name:a.lang.format.tag_h5,iconClass:"fa fa-header",description:a.localization.get("xwiki-slash.action.h5.hint"),command:{name:"xwiki-applyStyle",data:{element:"h5"}}},{group:"Layout",id:"h6",name:a.lang.format.tag_h6,iconClass:"fa fa-header",description:a.localization.get("xwiki-slash.action.h6.hint"),
command:{name:"xwiki-applyStyle",data:{element:"h6"}}},{group:"Layout",id:"p",name:a.localization.get("xwiki-slash.action.p.name"),iconClass:"fa fa-paragraph",description:a.localization.get("xwiki-slash.action.p.hint"),command:{name:"xwiki-applyStyle",data:{element:"p"}}},{group:"Layout",id:"ul",name:a.localization.get("xwiki-toolbar.bulletedlist"),iconClass:"fa fa-list-ul",description:a.localization.get("xwiki-slash.action.ul.hint"),command:"bulletedlist"},{group:"Layout",id:"ol",name:a.localization.get("xwiki-toolbar.numberedlist"),
iconClass:"fa fa-list-ol",description:a.localization.get("xwiki-slash.action.ol.hint"),command:"numberedlist"},{group:"Layout",id:"table",name:a.lang.table.toolbar,iconClass:"fa fa-table",description:a.localization.get("xwiki-slash.action.table.hint"),command:"table"},{group:"Layout",id:"blockquote",name:a.localization.get("xwiki-slash.action.blockquote.name"),iconClass:"fa fa-quote-left",description:a.localization.get("xwiki-slash.action.blockquote.hint"),command:"blockquote"},{group:"Layout",id:"macro-info",
name:a.localization.get("xwiki-toolbar.infoBox"),iconClass:"fa fa-info-circle",description:a.localization.get("xwiki-slash.action.info.hint"),command:{name:"xwiki-macro-insert",data:{name:"info",content:a.localization.get("xwiki-slash.action.info.defaultContent")}}},{group:"Layout",id:"macro-success",name:a.localization.get("xwiki-toolbar.successBox"),iconClass:"fa fa-check-circle",description:a.localization.get("xwiki-slash.action.success.hint"),command:{name:"xwiki-macro-insert",data:{name:"success",
content:a.localization.get("xwiki-slash.action.success.defaultContent")}}},{group:"Layout",id:"macro-warning",name:a.localization.get("xwiki-toolbar.warningBox"),iconClass:"fa fa-exclamation-triangle",description:a.localization.get("xwiki-slash.action.warning.hint"),command:{name:"xwiki-macro-insert",data:{name:"warning",content:a.localization.get("xwiki-slash.action.warning.defaultContent")}}},{group:"Layout",id:"macro-error",name:a.localization.get("xwiki-toolbar.errorBox"),iconClass:"fa fa-exclamation-circle",
description:a.localization.get("xwiki-slash.action.error.hint"),command:{name:"xwiki-macro-insert",data:{name:"error",content:a.localization.get("xwiki-slash.action.error.defaultContent")}}},{group:"Layout",id:"hr",name:a.localization.get("xwiki-toolbar.horizontalrule"),iconClass:"fa fa-minus",description:a.localization.get("xwiki-slash.action.hr.hint"),command:"horizontalrule"},{group:"Content",id:"a",name:a.lang.link.toolbar,iconClass:"fa fa-link",shortcut:"[",description:a.localization.get("xwiki-slash.action.a.hint"),
outputHTML:"["},{group:"Content",id:"img",name:a.lang.common.image,iconClass:"fa fa-image",description:a.localization.get("xwiki-slash.action.img.hint"),outputHTML:"img::"},{group:"Content",id:"icon",name:a.localization.get("xwiki-slash.action.icon.name"),iconClass:"fa fa-image",description:a.localization.get("xwiki-slash.action.icon.hint"),outputHTML:"icon::"},{group:"Content",id:"mention",name:a.localization.get("xwiki-slash.action.mention.name"),iconClass:"fa fa-user-o",shortcut:"@",description:a.localization.get("xwiki-slash.action.mention.hint"),
outputHTML:"@"},{group:"Content",id:"emoji",name:a.localization.get("xwiki-slash.action.emoji.name"),iconClass:"fa fa-smile-o",shortcut:":",description:a.localization.get("xwiki-slash.action.emoji.hint"),outputHTML:":sm"},{group:"Content",id:"macro-include",name:a.localization.get("xwiki-toolbar.include"),iconClass:"fa fa-file-text-o",description:a.localization.get("xwiki-slash.action.include.hint"),command:{name:"xwiki-macro",data:{name:"include"}}},{group:"Formatting",id:"macro-code",name:a.localization.get("xwiki-toolbar.code"),
iconClass:"fa fa-code",description:a.localization.get("xwiki-slash.action.code.hint"),command:{name:"xwiki-macro",data:{name:"code",parameters:{language:"none"}}}},{group:"Navigation",id:"macro-toc",name:a.localization.get("xwiki-toolbar.toc"),iconClass:"fa fa-list",description:a.localization.get("xwiki-slash.action.toc.hint"),command:{name:"xwiki-macro-insert",data:{name:"toc"}}},{group:"Actions",id:"find",name:a.lang.find.title,iconClass:"fa fa-search",description:a.localization.get("xwiki-slash.action.find.hint"),
command:"find"},{group:"Table",id:"table_row_before",name:a.lang.table.row.insertBefore,iconClass:"fa fa-plus",description:a.localization.get("xwiki-slash.action.table_row_before.hint"),command:"rowInsertBefore"},{group:"Table",id:"table_row_after",name:a.lang.table.row.insertAfter,iconClass:"fa fa-plus",description:a.localization.get("xwiki-slash.action.table_row_after.hint"),command:"rowInsertAfter"},{group:"Table",id:"table_row_delete",name:a.localization.get("xwiki-slash.action.table_row_delete.name"),
iconClass:"fa fa-trash",description:a.localization.get("xwiki-slash.action.table_row_delete.hint"),command:"rowDelete"},{group:"Table",id:"table_col_before",name:a.lang.table.column.insertBefore,iconClass:"fa fa-plus",description:a.localization.get("xwiki-slash.action.table_col_before.hint"),command:"columnInsertBefore"},{group:"Table",id:"table_col_after",name:a.lang.table.column.insertAfter,iconClass:"fa fa-plus",description:a.localization.get("xwiki-slash.action.table_col_after.hint"),command:"columnInsertAfter"},
{group:"Table",id:"table_col_delete",name:a.localization.get("xwiki-slash.action.table_col_delete.name"),iconClass:"fa fa-trash",description:a.localization.get("xwiki-slash.action.table_col_delete.hint"),command:"columnDelete"},{group:"Table",id:"table_cell_split_horizontal",name:a.lang.table.cell.splitHorizontal,iconClass:"fa fa-bars",description:a.localization.get("xwiki-slash.action.table_cell_split_horizontal.hint"),command:"cellHorizontalSplit"},{group:"Table",id:"table_cell_split_vertical",
name:a.lang.table.cell.splitVertical,iconClass:"fa fa-columns",description:a.localization.get("xwiki-slash.action.table_cell_split_vertical.hint"),command:"cellVerticalSplit"},{group:"Table",id:"table_cell_merge_right",name:a.localization.get("xwiki-slash.action.table_cell_merge_right.name"),iconClass:"fa fa-compress",description:a.localization.get("xwiki-slash.action.table_cell_merge_right.hint"),command:"cellMergeRight"},{group:"Table",id:"table_cell_merge_down",name:a.localization.get("xwiki-slash.action.table_cell_merge_down.name"),
iconClass:"fa fa-compress",description:a.localization.get("xwiki-slash.action.table_cell_merge_down.hint"),command:"cellMergeDown"},{group:"Table",id:"table_cell_before",name:a.lang.table.cell.insertBefore,iconClass:"fa fa-plus",description:a.localization.get("xwiki-slash.action.table_cell_before.hint"),command:"cellInsertBefore"},{group:"Table",id:"table_cell_after",name:a.lang.table.cell.insertAfter,iconClass:"fa fa-plus",description:a.localization.get("xwiki-slash.action.table_cell_after.hint"),
command:"cellInsertAfter"},{group:"Table",id:"table_cell_delete",name:a.localization.get("xwiki-slash.action.table_cell_delete.name"),iconClass:"fa fa-trash",description:a.localization.get("xwiki-slash.action.table_cell_delete.hint"),command:"cellDelete"},{group:"Table",id:"table_delete",name:a.lang.table.deleteTable,iconClass:"fa fa-trash",description:a.localization.get("xwiki-slash.action.table_delete.hint"),command:"tableDelete"}]);a.quickActions.addGroups(a.config.extraQuickActionGroups||[]);
a.quickActions.addActions(a.config.extraQuickActions||[]);a.addCommand("xwiki-applyStyle",{exec:function(l,m){l.applyStyle(new CKEDITOR.style(m))}});var t=function(l){var m=a.config.removeQuickActions||[];return l.filter(function(r){return 0>m.indexOf(r.score?r.item.id:r.id)}).filter(function(r){(r=r.score?r.item.command:r.command)&&"string"!=typeof r&&(r=r.name);return!r||a.getCommand(r).state!==CKEDITOR.TRISTATE_DISABLED})};new CKEDITOR.plugins.AdvancedAutoComplete(a,{marker:"/",itemTemplate:['<li data-id="{id}" class="ckeditor-autocomplete-item"><div class="ckeditor-autocomplete-item-head"><span class="ckeditor-autocomplete-item-icon-wrapper"><img src="{iconURL}"/><span class="{iconClass}"></span></span><span class="ckeditor-autocomplete-item-label">{name}</span><span class="ckeditor-autocomplete-item-shortcut">{shortcut}</span></div><div class="ckeditor-autocomplete-item-badges">',
...Array(a.quickActions.config.maxBadges).fill().map(function(l,m){return'<span class="badge ckeditor-autocomplete-item-badge">{badge'+(m+1)+"}</span>"}),'</div><div class="ckeditor-autocomplete-item-hint">{description}</div></li>'].join(""),dataCallback:function(l,m){l=l.query.substring(1);a.quickActions.search(l).then(function(r){m(a.quickActions.sort(t(r)))}).catch(function(r){console.error("Failed to search quick actions because: "+r);m([])})}})}})})();(function(){var c=jQuery;CKEDITOR.config["xwiki-source"]=CKEDITOR.config["xwiki-source"]||{__namespace:!0};CKEDITOR.plugins.xwikiSource={convertHTML:function(k,g){var d={};c(document).trigger("xwiki:wysiwyg:convertHTML",d);var e={sourceSyntax:k.config.sourceSyntax,wysiwygRestricted:"true"===k.element.getAttribute("data-restricted"),stripHTMLEnvelope:k.elementMode===CKEDITOR.ELEMENT_MODE_INLINE};g=c.extend(d,c.extend(e,g));return c.post(k.config["xwiki-source"].htmlConverter,g)},getFullData:function(k){var g=
k.config.fullData;k.config.fullData=!0;var d=k.getData();k.config.fullData=g;return d}};CKEDITOR.plugins.add("xwiki-source",{requires:"notification,xwiki-loading,xwiki-localization,xwiki-selection,xwiki-sourcearea",beforeInit:function(k){k.config["xwiki-source"]=c.extend({htmlConverter:k.config.sourceDocument.getURL("get",c.param({sheet:"CKEditor.HTMLConverter",outputSyntax:"plain",language:c("html").attr("lang")||"",formToken:document.documentElement.dataset.xwikiFormToken||""}))},k.config["xwiki-source"])},
afterInit:function(k){var g=k.getCommand("source");if(g){k.on("beforeSetMode",this.onBeforeSetMode.bind(this));k.on("beforeModeUnload",this.onBeforeModeUnload.bind(this));k.on("mode",this.onMode.bind(this));var d=g.checkAllowed;g.checkAllowed=function(){return!this.running&&d.apply(this,arguments)}}},onBeforeSetMode:function(k){var g=k.editor,d=g.mode&&(g._.modes[g.mode]||{}).failed;this.isModeSupported(k.data)&&!d&&this.startLoading(g)},isModeSupported:function(k){return"wysiwyg"===k||"source"===
k},onBeforeModeUnload:function(k){var g=k.editor;if(this.isModeSupported(g.mode))if(k=g._.modes[g.mode],k.failed)k.dirty=k.failed=!1,delete k.data;else{var d=k.data;g=CKEDITOR.plugins.xwikiSource.getFullData(g);k.dirty=d!==g;k.data=g}},onMode:function(k){k=k.editor;var g;"wysiwyg"===k.mode&&"source"===k._.previousMode?g=this.maybeConvertHTML(k,!0):"source"===k.mode&&"wysiwyg"===k._.previousMode?g=this.maybeConvertHTML(k,!1):this.isModeSupported(k.mode)&&(g=c.Deferred().resolve(k));g&&g.always(this.endLoading.bind(this)).done(k.fire.bind(k,
"modeReady"))},maybeConvertHTML:function(k,g){var d=k._.modes[k.mode];if(k._.modes[k._.previousMode].dirty||"string"!==typeof d.data)return this.convertHTML(k,g);g=c.Deferred();k.setData(d.data,{callback:g.resolve.bind(g,k)});return g.promise()},convertHTML:function(k,g){var d=c.Deferred();CKEDITOR.plugins.xwikiSource.convertHTML(k,{fromHTML:!g,toHTML:g,text:k._.previousModeData}).done(function(e){k.setData(e,{callback:function(){k._.modes[k.mode].data=CKEDITOR.plugins.xwikiSource.getFullData(k);
d.resolve(k)}})}).fail(function(){k._.modes[k.mode].failed=!0;k.setMode(k._.previousMode,function(){d.reject(k);k.showNotification(k.localization.get("xwiki-source.conversionFailed"),"warning")})});return d.promise()},startLoading:function(k){CKEDITOR.plugins.xwikiSelection.saveSelection(k);k.setLoading(!0);var g=k.getCommand("source");g.running=!0;g.setState(CKEDITOR.TRISTATE_DISABLED);"source"===k.mode&&k.fire("lockSnapshot");k.editable()&&c(k.container.$).find(".cke_button__source_icon").first().addClass("loading");
k.document&&k.document!=CKEDITOR.document&&CKEDITOR.env.ie&&!CKEDITOR.env.edge&&k.document.$.execCommand("SelectAll",!1,null)},endLoading:function(k){k.editable()&&c(k.container.$).find(".cke_button__source_icon").first().removeClass("loading");"wysiwyg"===k.mode&&k.fire("unlockSnapshot");var g=k.getCommand("source");g.running=!1;g.setState("source"!==k.mode?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_ON);k.setLoading(!1);CKEDITOR.plugins.xwikiSelection.restoreSelection(k)}})})();(function(){var c=jQuery;CKEDITOR.plugins.add("xwiki-sourcearea",{requires:"xwiki-selection",init:function(d){d.addMode("source",function(b){var f=d.ui.space("contents"),n=f.getDocument().createElement("textarea");n.setStyles(CKEDITOR.tools.extend({width:"100%",height:"100%",resize:"none",outline:"none","text-align":"left"},CKEDITOR.tools.cssVendorPrefix("tab-size",d.config.sourceAreaTabSize||2)));n.setAttribute("dir","ltr");n.addClass("cke_source").addClass("cke_enable_context_menu");if(d.elementMode===
CKEDITOR.ELEMENT_MODE_INLINE){var h=d.getCommand("maximize")||{};g(n.$,f.getSize("height",!0),function(){return h.state!==CKEDITOR.TRISTATE_ON})}else n.addClass("cke_reset");f.append(n);d.editable(new k(d,n)).setData(d.getData(1));d.fire("ariaWidget",this);b()});d.addCommand("source",{modes:{wysiwyg:1,source:1},editorFocus:!1,readOnly:1,exec:function(b){"wysiwyg"===b.mode&&b.fire("saveSnapshot");b.getCommand("source").setState(CKEDITOR.TRISTATE_DISABLED);b.setMode("source"===b.mode?"wysiwyg":"source")},
canUndo:!1});d.on("mode",function(){d.getCommand("source").setState("source"===d.mode?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF)});d.ui.addButton&&d.ui.addButton("Source",{label:d.lang.sourcearea.toolbar,command:"source",toolbar:"mode,10"});if(d.elementMode===CKEDITOR.ELEMENT_MODE_INLINE){d.on("maximize",function(b){b.data!==CKEDITOR.TRISTATE_ON&&"source"===d.mode&&e(d)});require(["centerTextAreaSelectionVertically"],function(b){d.on("modeReady",function(){"source"===d.mode&&e(d)})});var e=function(b){c(b.editable().$).trigger("input").centerTextAreaSelectionVertically({padding:65})}}}});
var k=CKEDITOR.tools.createClass({base:CKEDITOR.editable,proto:{setData:function(d){this.setValue(d);this.status="ready";this.editor.fire("dataReady")},getData:function(){return this.getValue()},insertHtml:function(){},insertElement:function(){},insertText:function(){},setReadOnly:function(d){this[(d?"set":"remove")+"Attribute"]("readOnly","readonly")},detach:function(){k.baseProto.detach.call(this);this.clearCustomData();this.remove()}}}),g=function(d,e,b){var f=function(n){var h=c(n);h.parent().css("min-height",
h.height()+"px");h.css({height:"auto","overflow-y":"hidden"}).height(n.scrollHeight);h.parent().css("min-height","");return h};(b()?e?c(d).height(e):f(d):c(d)).off("input.autoHeight").on("input.autoHeight",function(){b()&&f(this)})}})();
define("centerTextAreaSelectionVertically",["jquery","scrollUtils"],function(c,k){var g=function(d){var e=d.selectionStart,b=d.selectionEnd,f=d.value,n={};["height","overflowY"].forEach(function(t){n[t]=d.style[t]||""});var h=c(d).css({height:0,"overflow-y":"hidden"}).val(f.substring(0,e)),a=d.scrollHeight;h.css(n).val(f);d.setSelectionRange(e,b);return a};c.fn.centerTextAreaSelectionVertically=function(d){d=d||{};return this.filter("textarea").each(function(){var e=d,b=k.getVerticalScrollParent(this);
if(b){var f=k.getRelativeTopOffset(this,b),n=g(this);f+=n;e.padding&&k.isCenteredVertically(b,e.padding,f)||(b.scrollTop=f-b.clientHeight/2)}})};return c});(function(){var c=jQuery;c(document).on("xwiki:document:syntaxChange.ckeditor",function(h,a){c.each(CKEDITOR.instances,function(t,l){k(l,h,a)})});var k=function(h,a,t){g(h,a,t)&&(t.promise=t.promise.then(function(){var l=new XWiki.widgets.Notification(h.localization.get("xwiki-syntax.update.inProgress"),"inprogress");return d(h,t).done(function(){l.replace(new XWiki.widgets.Notification(h.localization.get("xwiki-syntax.update.done"),"done"))}).fail(function(){l.replace(new XWiki.widgets.Notification(h.localization.get("xwiki-syntax.update.failed"),
"error"))})}))},g=function(h,a,t){a=c(a.target).closest("form, .form");return h.config.sourceDocument.documentReference.equals(t.documentReference)&&h.plugins["xwiki-syntax"]&&(!t.reverting||!c.contains(a[0],h.element.$))},d=function(h,a){h.element.setAttribute("data-syntax",a.syntax.id);h.config.sourceSyntax=a.syntax.id;return e(h,a).then(b.bind(null,h,a.syntax))},e=function(h,a){return"wysiwyg"===h.mode&&a.convertSyntax&&a.syntax.parser?CKEDITOR.plugins.xwikiSource.convertHTML(h,{fromHTML:!0,toHTML:!1,
sourceSyntax:a.previousSyntax.id,text:h.getData()}).then(a.syntaxConverter.convert.bind(a.syntaxConverter,a.syntax,a.previousSyntax)).then(function(t){return CKEDITOR.plugins.xwikiSource.convertHTML(h,{fromHTML:!1,toHTML:!0,sourceSyntax:a.syntax.id,text:t})}):"source"===h.mode&&a.convertSyntax?a.syntaxConverter.convert(a.syntax,a.previousSyntax,h.getData()):a.syntax.renderer||"source"===h.mode?c.Deferred().resolve(CKEDITOR.plugins.xwikiSource.getFullData(h)).promise():CKEDITOR.plugins.xwikiSource.convertHTML(h,
{fromHTML:!0,toHTML:!1,sourceSyntax:a.previousSyntax.id,text:h.getData()})},b=function(h,a,t){var l=c.Deferred(),m={promise:l.promise()},r=a.renderer?h.mode:"source";h.fireOnce("reload",m);h.destroy(!0);m.promise=m.promise.then(f.bind(null,r,t)).then(n.bind(null,t)).done(function(q){a.renderer||(q.getCommand("source").disable(),q.showNotification(q.localization.get("xwiki-syntax.wysiwygModeUnsupported",a.label),"warning"))});l.resolve({startupMode:r});return m.promise},f=function(h,a,t){var l=c.Deferred();
if(h===t.mode)l.resolve(t);else{var m=t._.modes[t.mode];m.data=CKEDITOR.plugins.xwikiSource.getFullData(t);t._.modes[h].data=a;t.setMode(h,function(){delete m.data;l.resolve(t)})}return l.promise()},n=function(h,a){var t=c.Deferred();a.setData(h,{callback:function(){t.resolve(a)}});return t.promise()};CKEDITOR.plugins.add("xwiki-syntax",{requires:"notification,xwiki-localization,xwiki-source"})})();(function(){CKEDITOR.plugins.add("xwiki-table",{requires:"table",init:function(l){var m=!l.config.tableUseAlignAttribute,r=l.dataProcessor&&l.dataProcessor.dataFilter;r&&m&&r.addRules(g,{priority:5});(l=l.dataProcessor&&l.dataProcessor.htmlFilter)&&m&&l.addRules(h,{priority:14,applyToAll:!0})}});CKEDITOR.on("dialogDefinition",function(l){if(l.editor.plugins["xwiki-table"]){var m=l.data.definition;"table"===l.data.name&&c(m,l.editor)}});var c=function(l,m){var r=l.getContents("info");["txtBorder",
"txtWidth","txtCellSpace","txtCellPad"].forEach(function(q){delete r.get(q)["default"]})},k=/\bmargin\b/i,g={elements:{table:function(l){if(k.test(l.attributes.style)){var m=l.styles||CKEDITOR.tools.parseCssText(l.attributes.style,!0);f(m,"margin");"auto"===m["margin-left"]?(delete m["margin-left"],"auto"===m["margin-right"]?(delete m["margin-right"],l.attributes.align="center"):l.attributes.align="right",l.attributes.style=CKEDITOR.tools.writeCssText(m)):"auto"===m["margin-right"]&&(delete m["margin-right"],
l.attributes.align="left",l.attributes.style=CKEDITOR.tools.writeCssText(m))}}}},d=function(l){return[l+"-top",l+"-right",l+"-bottom",l+"-left"]},e=[[0,0,0,0],[0,1,0,1],[0,1,2,1],[0,1,2,3]],b=function(l,m,r){var q=l.split(/\s+/);e[q.length-1].forEach(function(p,u){r[m[u]]=q[p]})},f=function(l,m){l[m]&&(b(l[m],d(m),l),delete l[m])},n={left:["margin-right"],right:["margin-left"],center:["margin-left","margin-right"]},h={elements:{table:function(l){var m=n[l.attributes.align];if(m){delete l.attributes.align;
var r=l.styles||CKEDITOR.tools.parseCssText(l.attributes.style||"",!0);f(r,"margin");m.forEach(function(q){r[q]="auto"});t(r,"margin");l.attributes.style=CKEDITOR.tools.writeCssText(r)}}}},a=function(l){l[1]===l[3]&&(l=l.slice(0,3),l[0]===l[2]&&(l=l.slice(0,2),l[0]===l[1]&&(l=l.slice(0,1))));return l},t=function(l,m){for(var r=d(m),q=[],p=0;p<r.length;p++){var u=l[r[p]];if(u)q.push(u);else return}l[m]=a(q).join(" ");r.forEach(function(v){delete l[v]})};CKEDITOR.plugins.xwikiTable={replaceMarginAutoWithAlign:g.elements.table,
replaceAlignWithMarginAuto:h.elements.table}})();(function(){var c=jQuery;CKEDITOR.plugins.add("xwiki-toolbar",{requires:"menu,menubutton,xwiki-localization",afterInit:function(g){var d=g.config.toolbarMenus||{},e=g.config.toolbarMenuItems||{},b=Object.keys(g.ui.items).map(function(n){return n.toLowerCase()}),f=(g.config.removeButtons||"").toLowerCase();c.each(d,function(n,h){var a=[],t=100;h.groups.forEach(function(l){g.addMenuGroup(l.id,t);t+=10;l.items.forEach(function(m,r){m=c.extend({id:"toolbar_"+m,label:"xwiki-toolbar."+m,command:m},e[m]);
var q=m.command;g.addMenuItem(m.id,{label:k(g,m.label),icon:m.icon||q,command:q,data:m.data,group:l.id,order:r+1,onClick:function(){g.execCommand(this.command,this.data)}});g.commands[q]&&(0>b.indexOf(q.toLowerCase())||0<=f.indexOf(q.toLowerCase()))&&a.push(m)})});0<a.length&&g.ui.add(n,CKEDITOR.UI_MENUBUTTON,{label:k(g,h.label||"xwiki-toolbar."+n),icon:h.icon||a[0].command.toLowerCase(),toolbar:h.toolbar,modes:{wysiwyg:1},onMenu:function(){var l={};a.forEach(function(m){l[m.id]=g.commands[m.command].state;
m.icon&&l[m.id]&&g.ui.instances[n]._.menu._.panelDefinition.css.push(".cke_button__"+m.command+"_icon {"+CKEDITOR.skin.getIconStyle(m.icon)+"}")});return l},refresh:function(){setTimeout(function(){var l=a.some(function(m){return g.commands[m.command].state});this.setState(l?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED)}.bind(this),0)}})});g.ui.items.Format&&(g.ui.items.Format.toolbar="format,10")}});var k=function(g,d){if("xwiki-"===d.substring(0,6))return g.localization.get(d);var e=g.lang;
d.split(".").forEach(function(b){e=(e||{})[b]});return e||d}})();(function(){var c=jQuery;CKEDITOR.config["xwiki-upload"]=CKEDITOR.config["xwiki-upload"]||{__namespace:!0};CKEDITOR.plugins.add("xwiki-upload",{requires:"uploadfile,uploadimage,xwiki-marker,xwiki-resource",init:function(e){g(e);d(e)},afterInit:function(e){this.overrideUploadWidget(e,"uploadfile",!0,function(n,h){var a=n.replace;h={"data-linktype":"attachment","data-freestanding":!0,"data-wikigeneratedlinkcontent":h.fileName,"data-reference":h.responseData.resourceReference};var t=[];for(l in h)h.hasOwnProperty(l)&&
t.push(l+'="'+CKEDITOR.tools.htmlEncodeAttr(h[l])+'"');var l=t.join(" ");return a.call(n,/<a\b/i,"<a "+l)});this.overrideUploadWidget(e,"uploadimage",!1,function(n,h){return"\x3c!--startimage:"+CKEDITOR.tools.escapeComment(h.responseData.resourceReference)+'--\x3e<img src="'+(h.url+'"/>\x3c!--stopimage--\x3e')});var b=e.uploadRepository.create,f=!1;e.on("beforePaste",function(n){f=n.data&&"paste"===n.data.method});e.on("afterPaste",function(){f=!1});e.uploadRepository.create=function(n,h){f&&("string"===
typeof n?h=(n.match(k)?.[1]||"").split("/").slice(1).join("/"):"string"===typeof n.name?h=n.name.split(".").slice(1).join("."):(console.debug("Unexpected file: ",n),h=""),h=`${Date.now()}-${Math.floor(900*Math.random())+100}.${h}`);return b.call(this,n,h)}},overrideUploadWidget:function(e,b,f,n){if(e=e.widgets.registered[b]){n=n||function(t,l){return t};var h=e.onUploaded;e.onUploaded=function(t){this._upload=t;h.call(this,t)};var a=e.replaceWith;e.replaceWith=function(t,l){var m=this._upload;delete this._upload;
m&&(m.responseData.resourceReference.typed=f,m.responseData.resourceReference=CKEDITOR.plugins.xwikiResource.serializeResourceReference(m.responseData.resourceReference),t=n(t,m));a.call(this,t,l)}}}});const k=/^data:(\S*?);base64,/;var g=function(e){var b=c.Deferred().resolve();e.on("fileUploadRequest",function(f){var n=f.data.fileLoader.xhr,h=c.Deferred();n.addEventListener("loadend",h.resolve.bind(h));var a=n.send;n.send=function(){var t=arguments;b=b.then(function(){a.apply(n,t);return h.promise()})}},
null,null,1)},d=function(e){e.on("fileUploadRequest",function(b){e.config["xwiki-upload"]&&b.data.fileLoader.xhr.setRequestHeader("X-XWiki-Temporary-Attachment-Support",e.config["xwiki-upload"].isTemporaryAttachmentSupported)});e.on("fileUploadResponse",function(b){e.config["xwiki-upload"].isTemporaryAttachmentSupported&&c("<input>").attr({type:"hidden",name:"uploadedFiles",value:JSON.parse(b.data.fileLoader.xhr.responseText).fileName}).insertAfter(c(e.element.$))})}})();(function(){CKEDITOR.plugins.add("xwiki-wysiwygarea",{requires:"wysiwygarea",init:function(c){c.config.fullPage&&this.injectPluginStyles(c);c.elementMode===CKEDITOR.ELEMENT_MODE_INLINE&&this.overwriteWysiwygMode(c)},injectPluginStyles:function(c){c.on("toHtml",function(k){if(CKEDITOR.tools.isArray(c.config.contentsCss)&&(k=k.data.dataValue,"function"===typeof k.find&&(k=k.find("head",!0),0!==k.length))){var g=k[0];c.config.contentsCss.forEach(function(d){0<d.indexOf("/plugins/")&&g.children.push(new CKEDITOR.htmlParser.element("link",
{rel:"stylesheet",type:"text/css",href:d}))})}},null,null,14)},overwriteWysiwygMode:function(c){c.on("beforeModeUnload",function(){if("wysiwyg"===c.mode){var k=c.element.getDocument().createElement("div");var g=(c.element.getAttribute("class")||"").split(/\s+/).filter(function(d){return"cke_"!==d.substring(0,4)}).join(" ");k.setAttributes({id:c.ui.spaceId("contents"),"class":"cke_contents fake "+g,role:"presentation"});k.setStyles({"min-height":c.element.getSize("height",!0)+"px",visibility:"hidden"});
c.element.$.parentNode.replaceChild(k.$,c.element.$);c.element.hide();c.element.insertBefore(k);c.container=c.ui.contentsElement=k;c.once("contentDomUnload",function(){c.editable().clearCustomData()})}else k=c.ui.space("contents"),k.setStyle("min-height",k.getSize("height",!0)+"px")});c.addMode("wysiwyg",function(k){var g=c.ui.space("contents");c.element.remove().setStyle("min-height",g.getSize("height",!0)+"px").show();g.$.parentNode.replaceChild(c.element.$,g.$);c.editable(c.element);c.container=
c.ui.contentsElement=c.element;c.fire("contentDom");k()});c.on("modeReady",function(){"wysiwyg"===c.mode?c.element.removeStyle("min-height"):c.ui.space("contents").setStyles({"min-height":"",visibility:""})});c.on("beforeDestroy",function(){c.element.show()})}})})();
//# sourceMappingURL=webjar.bundle.min.js.map
